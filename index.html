<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Elemental Catalyst v1.0</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Rajdhani:wght@500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{background:#030608;color:#d0dce8;font-family:'Rajdhani',sans-serif;overflow:hidden;user-select:none;display:flex;align-items:center;justify-content:center;min-height:100vh;}
.screen{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;}
.screen.hidden{display:none!important;}
canvas{display:block;cursor:crosshair;}
.gtitle{font-family:'Cinzel',serif;font-size:clamp(26px,4vw,52px);font-weight:900;background:linear-gradient(135deg,#ffa366,#f4c542,#b3e5fc);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:5px;}
.gsub{font-size:10px;color:#2a3a50;letter-spacing:3px;text-transform:uppercase;}
/* â”€â”€â”€ MAIN MENU â”€â”€â”€ */
#menu{background:radial-gradient(ellipse 130% 100% at 50% 60%,#0b1624 0%,#030608 100%);}
.menu-btns{display:flex;flex-direction:column;gap:12px;align-items:center;}
.mbtn{width:280px;padding:14px 32px;font-family:'Cinzel',serif;font-size:14px;letter-spacing:3px;border:none;border-radius:8px;cursor:pointer;font-weight:700;transition:all .22s;background:transparent;border:1px solid #1e2a38;color:#d0dce8;}
.mbtn:hover{transform:translateY(-2px);}
.mbtn.primary{background:linear-gradient(135deg,#f4c542,#ff8c00);color:#000;border:none;}
.mbtn.primary:hover{box-shadow:0 8px 28px rgba(244,197,66,.4);}
.mbtn.blue{border-color:#42a5f544;color:#42a5f5;}
.mbtn.blue:hover{background:#42a5f511;border-color:#42a5f5;}
.mbtn.purple{border-color:#a855f744;color:#a855f7;}
.mbtn.purple:hover{background:#a855f711;border-color:#a855f7;}
/* â”€â”€â”€ LOBBY â”€â”€â”€ */
#lobby{background:radial-gradient(ellipse at 50% 60%,#0c1828 0%,#030608 100%);}
.lobby-box{background:#070f1a;border:1px solid #1a2a3a;border-radius:12px;padding:28px 36px;display:flex;flex-direction:column;gap:16px;width:400px;}
.lobby-title{font-family:'Cinzel',serif;font-size:16px;color:#f4c542;letter-spacing:2px;}
.room-code{font-family:'Share Tech Mono',monospace;font-size:36px;font-weight:700;letter-spacing:10px;color:#4fc3f7;text-align:center;padding:12px;background:#040c16;border-radius:8px;border:1px solid #4fc3f744;}
.lbl{font-size:11px;color:#4a6375;letter-spacing:2px;text-transform:uppercase;}
.inp{width:100%;padding:10px 14px;background:#040c16;border:1px solid #1a2a3a;border-radius:6px;color:#d0dce8;font-family:'Share Tech Mono',monospace;font-size:22px;letter-spacing:8px;text-transform:uppercase;text-align:center;outline:none;}
.inp:focus{border-color:#4fc3f7;}
.status-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:#2a3a4a;margin-right:6px;}
.status-dot.waiting{background:#f4c542;box-shadow:0 0 8px #f4c542aa;animation:pulse2 1.2s infinite;}
.status-dot.connected{background:#4ade80;box-shadow:0 0 8px #4ade8088;}
@keyframes pulse2{0%,100%{opacity:1;}50%{opacity:.4;}}
.lobby-status{font-size:12px;font-family:'Share Tech Mono',monospace;color:#4a6375;}
.divider{border:none;border-top:1px solid #1a2a3a;}
/* â”€â”€â”€ LEVEL SELECT â”€â”€â”€ */
#levelselect{background:radial-gradient(ellipse at 50% 60%,#0a1620 0%,#030608 100%);}
.levels-grid{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;max-width:780px;}
.lcard{width:105px;height:130px;border-radius:10px;background:#080f1a;border:1.5px solid #1a2a3a;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;transition:all .2s;position:relative;}
.lcard:hover{transform:translateY(-3px);}
.lcard.locked{opacity:.3;cursor:not-allowed;pointer-events:none;}
.lcard.completed{border-color:#4ade8066;}
.lcard.current{border-color:#f4c54266;}
.lem{font-size:28px;}
.lname{font-family:'Cinzel',serif;font-size:9px;letter-spacing:1px;text-align:center;padding:0 4px;}
.ldiff{font-size:8px;color:#3a5060;}
.lbadge{position:absolute;top:4px;right:4px;font-size:11px;}
/* â”€â”€â”€ DRAFT â”€â”€â”€ */
#draft{background:radial-gradient(ellipse 130% 100% at 50% 60%,#0b1624 0%,#030608 100%);}
.plabel{font-family:'Cinzel',serif;font-size:18px;font-weight:700;letter-spacing:2px;min-height:24px;text-align:center;}
.pstep{font-family:'Share Tech Mono',monospace;font-size:10px;color:#4a6375;letter-spacing:2px;text-align:center;}
.cards{display:flex;gap:14px;}
.card{width:112px;height:152px;border-radius:11px;background:#080f1a;border:1.5px solid #1a2a3a;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;transition:all .2s;}
.card:hover{transform:translateY(-4px);}
.card.sel{transform:translateY(-4px) scale(1.06);}
.card.dim{opacity:.2;pointer-events:none;}
.cem{font-size:34px;}.cname{font-family:'Cinzel',serif;font-size:10px;letter-spacing:2px;}
.crole{font-size:9px;color:#3a5060;text-align:center;padding:0 6px;}
.lrow{display:flex;gap:8px;align-items:center;min-height:26px;flex-wrap:wrap;justify-content:center;}
.ls{display:flex;align-items:center;gap:5px;padding:3px 10px;border-radius:18px;border:1px solid #1e2a38;background:#070f19;font-size:11px;}
/* â”€â”€â”€ LEVEL COMPLETE â”€â”€â”€ */
#levelcomplete{background:rgba(3,6,8,.96);}
.lc-title{font-family:'Cinzel',serif;font-size:clamp(30px,5vw,52px);font-weight:900;color:#f4c542;text-shadow:0 0 50px rgba(244,197,66,.5);letter-spacing:4px;}
.lc-stats{display:flex;gap:24px;font-family:'Share Tech Mono',monospace;font-size:12px;color:#4a6375;}
.lc-stat{display:flex;flex-direction:column;align-items:center;gap:4px;}
.lc-stat b{font-size:22px;color:#d0dce8;}
.lc-boss{font-size:48px;}
/* â”€â”€â”€ GAME OVER â”€â”€â”€ */
#win,#lose{background:rgba(3,6,8,.97);}
.end-t{font-family:'Cinzel',serif;font-size:clamp(36px,6vw,64px);font-weight:900;letter-spacing:6px;}
.win-t{color:#f4c542;text-shadow:0 0 55px rgba(244,197,66,.5);}
.lose-t{color:#f87171;text-shadow:0 0 55px rgba(248,113,113,.4);}
/* â”€â”€â”€ BUTTONS â”€â”€â”€ */
.btn{padding:9px 40px;font-family:'Cinzel',serif;font-size:12px;letter-spacing:3px;border:none;border-radius:6px;cursor:pointer;font-weight:700;transition:all .2s;}
.btn-go{background:linear-gradient(135deg,#f4c542,#ff8c00);color:#000;opacity:.15;pointer-events:none;}
.btn-go.rdy{opacity:1;pointer-events:all;}
.btn-go.rdy:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(244,197,66,.4);}
.btn-back{background:transparent;color:#d0dce8;border:1px solid #2a3a4a;}
.btn-back:hover{border-color:#f4c542;color:#f4c542;}
.btn-next{background:linear-gradient(135deg,#4ade80,#16a34a);color:#000;border:none;padding:12px 44px;font-family:'Cinzel',serif;font-size:13px;letter-spacing:3px;border-radius:8px;cursor:pointer;font-weight:700;}
.btn-next:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(74,222,128,.4);}
.ctrls{font-family:'Share Tech Mono',monospace;font-size:8px;color:#1e2d3a;letter-spacing:1px;text-align:center;line-height:2;}
.eff-row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;font-family:'Share Tech Mono',monospace;font-size:8px;max-width:680px;color:#3a5060;}
/* â”€â”€â”€ TOOLTIP â”€â”€â”€ */
#tip{position:fixed;z-index:999;pointer-events:none;display:none;width:230px;background:#07101c;border:1px solid #1e3050;border-radius:9px;padding:11px 13px;box-shadow:0 8px 32px rgba(0,0,0,.85);}
#tip.on{display:block;}
.tn{font-family:'Cinzel',serif;font-size:13px;color:#f4c542;margin-bottom:2px;}
.tm{font-family:'Share Tech Mono',monospace;font-size:8px;color:#4a6375;margin-bottom:5px;}
.tt2{display:flex;flex-wrap:wrap;gap:3px;margin-bottom:5px;}
.tg{font-family:'Share Tech Mono',monospace;font-size:8px;padding:1px 5px;border-radius:3px;}
.ts2{display:grid;grid-template-columns:1fr 1fr;gap:2px;margin-bottom:5px;}
.tv{font-family:'Share Tech Mono',monospace;font-size:10px;color:#5a7090;}
.tv b{color:#d0dce8;}
.tdiv{border-top:1px solid #1a2535;margin:5px 0;}
.td{font-size:11px;color:#8090a8;line-height:1.5;margin-bottom:4px;}
.tst{font-size:10px;color:#a0b0c0;margin-bottom:3px;}
.tsy{font-size:10px;color:#f4c542;background:rgba(244,197,66,.06);padding:4px 7px;border-left:2px solid #f4c542;border-radius:0 3px 3px 0;}
</style>
</head>
<body>
<!-- â•â•â• SCREENS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- MAIN MENU -->
<div id="menu" class="screen">
  <div class="gsub">PROTOTYPE v1.0</div>
  <div class="gtitle">ELEMENTAL CATALYST</div>
  <div class="gsub" style="color:#2a4050;letter-spacing:2px">7 ELEMENTAL BOSSES Â· ONLINE CO-OP Â· DRAFT-SYSTEM</div>
  <div class="menu-btns">
    <button class="mbtn primary" onclick="goSolo()">âš” SOLO SPIELEN</button>
    <button class="mbtn blue" onclick="goCreateLobby()">ğŸŒ ONLINE â€” LOBBY ERSTELLEN</button>
    <button class="mbtn purple" onclick="goJoinLobby()">ğŸ”— ONLINE â€” LOBBY BEITRETEN</button>
  </div>
  <div class="eff-row">
    <span style="color:#ff5555">ğŸ”¥>ğŸŒ¿ ğŸ’§>ğŸ”¥ ğŸŒ¿>ğŸ’§ âœ¨â†”ğŸŒ‘ (2Ã—)</span>
    <span>ğŸŒ€â†’ğŸª¨ (0.5Ã—) Â· ğŸª¨â†’ğŸŒ€ (1.5Ã—)</span>
  </div>
</div>

<!-- LOBBY (CREATE) -->
<div id="lobbyCreate" class="screen hidden">
  <div class="lobby-box">
    <div class="lobby-title">ğŸŒ LOBBY ERSTELLEN</div>
    <div>
      <div class="lbl">Dein Raum-Code</div>
      <div class="room-code" id="roomCodeDisplay">...</div>
    </div>
    <div class="lobby-status"><span class="status-dot waiting" id="hostDot"></span><span id="hostStatus">Warte auf Mitspieler...</span></div>
    <div class="lbl" style="font-size:9px;color:#2a3a4a">Teile diesen Code mit deinem Mitspieler. Er kann damit beitreten.</div>
    <button class="btn btn-back" onclick="lobbyCancel()">ABBRECHEN</button>
  </div>
</div>

<!-- LOBBY (JOIN) -->
<div id="lobbyJoin" class="screen hidden">
  <div class="lobby-box">
    <div class="lobby-title">ğŸ”— LOBBY BEITRETEN</div>
    <div>
      <div class="lbl">Raum-Code eingeben</div>
      <input class="inp" id="joinCodeInp" maxlength="6" placeholder="XXXXXX" oninput="this.value=this.value.toUpperCase()">
    </div>
    <div class="lobby-status"><span class="status-dot" id="joinDot"></span><span id="joinStatus">Code eingeben und verbinden</span></div>
    <button class="mbtn primary" onclick="doJoin()" style="margin-top:4px">VERBINDEN</button>
    <button class="btn btn-back" onclick="lobbyCancel()">ABBRECHEN</button>
  </div>
</div>

<!-- LEVEL SELECT -->
<div id="levelselect" class="screen hidden">
  <div class="gsub">KAPITEL-AUSWAHL</div>
  <div class="gtitle" style="font-size:28px">ELEMENTAL JOURNEY</div>
  <div class="levels-grid" id="levelsGrid"></div>
  <button class="btn btn-back" onclick="goMenu()">â† HAUPTMENÃœ</button>
</div>

<!-- DRAFT -->
<div id="draft" class="screen hidden">
  <div class="gsub" id="draftModeLbl">SOLO</div>
  <div class="gtitle" style="font-size:28px">ELEMENT-DRAFT</div>
  <div class="eff-row">
    <span style="color:#ff5555">ğŸ”¥>ğŸŒ¿ ğŸ’§>ğŸ”¥ ğŸŒ¿>ğŸ’§ âœ¨â†”ğŸŒ‘ (2Ã—)</span>
  </div>
  <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
    <div class="plabel" id="plabel"></div>
    <div class="pstep" id="pstep"></div>
  </div>
  <div class="cards" id="cards"></div>
  <div class="lrow" id="lrow"></div>
  <button class="btn btn-go" id="btngo" onclick="startGame()">âš” KAMPF STARTEN</button>
  <div class="ctrls">
    P1: WASD Â· LMB Angriff Â· RMB(halten)=Charge Â· Q/E Skills Â· R=FUSION-ULTI Â· LEERTASTE Dash Â· TAB Element<br>
    P2(Lokal): IJKL Â· U Atk Â· O Charge Â· 1/2 Skills Â· 3 Fusion Â· Shift+R Dash Â· P Element
  </div>
</div>

<!-- GAME -->
<div id="game" class="screen hidden"><canvas id="cv"></canvas></div>

<!-- LEVEL COMPLETE -->
<div id="levelcomplete" class="screen hidden">
  <div class="lc-boss" id="lcBossEmoji">ğŸŒ‹</div>
  <div class="lc-title" id="lcTitle">BOSS BESIEGT!</div>
  <div id="lcBossName" style="font-family:'Share Tech Mono',monospace;font-size:12px;color:#4a6375;letter-spacing:3px;margin-top:-8px"></div>
  <div class="lc-stats" id="lcStats"></div>
  <button class="btn-next" id="btnNext" onclick="goNextLevel()">NÃ„CHSTES LEVEL â†’</button>
  <button class="btn btn-back" onclick="goMenu()">HAUPTMENÃœ</button>
</div>

<!-- GAME COMPLETE -->
<div id="win" class="screen hidden">
  <div class="end-t win-t">âœ¦ ALLES BESIEGT âœ¦</div>
  <div style="font-size:14px;color:#4a6375;text-align:center;max-width:500px" id="winsub"></div>
  <div style="font-size:32px;margin:8px 0">ğŸ”¥ğŸ’§ğŸª¨ğŸŒ€ğŸŒ¿âœ¨ğŸŒ‘</div>
  <button class="btn-next" onclick="goMenu()">HAUPTMENÃœ</button>
</div>
<div id="lose" class="screen hidden">
  <div class="end-t lose-t">NIEDERLAGE</div>
  <div style="font-size:13px;color:#4a6375;max-width:500px;text-align:center">Die Dunkelheit hat dich verschluckt. Steh wieder auf.</div>
  <button class="btn-next" style="background:linear-gradient(135deg,#ef4444,#991b1b);color:#fff;" onclick="retryLevel()">NOCHMAL VERSUCHEN</button>
  <button class="btn btn-back" onclick="goMenu()">HAUPTMENÃœ</button>
</div>

<div id="tip"></div>
<script>
'use strict';
const GW=1280,GH=740,PAD=48;
const PC=['#f4c542','#4fc3f7'];
const PN=['P1','P2'];

// â”€â”€â”€ ELEMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const EL={
  fire:    {n:'Feuer',    e:'ğŸ”¥',c:'#ff6b1a',g:'#ff4500'},
  water:   {n:'Wasser',  e:'ğŸ’§',c:'#42a5f5',g:'#1e88e5'},
  earth:   {n:'Erde',    e:'ğŸª¨',c:'#a3a86e',g:'#8d9234'},
  wind:    {n:'Wind',    e:'ğŸŒ€',c:'#4fc3f7',g:'#29b6f6'},
  nature:  {n:'Natur',   e:'ğŸŒ¿',c:'#4ade80',g:'#16a34a'},
  light:   {n:'Licht',   e:'âœ¨',c:'#fde68a',g:'#f59e0b'},
  darkness:{n:'Dunkel',  e:'ğŸŒ‘',c:'#a855f7',g:'#7e22ce'},
};
const ALL_EL=Object.keys(EL);
const ROLES={fire:'Pure DPS',water:'Healer',earth:'Tank',wind:'Mobility',nature:'Zoner',light:'Shielder',darkness:'Assassin'};

function getEff(a,d){
  if(a==='fire'&&d==='nature')return 2;if(a==='fire'&&d==='water')return.5;
  if(a==='water'&&d==='fire')return 2;if(a==='water'&&d==='nature')return.5;
  if(a==='nature'&&d==='water')return 2;if(a==='nature'&&d==='fire')return.5;
  if(a==='light'&&d==='darkness')return 2;if(a==='darkness'&&d==='light')return 2;
  if(a==='wind'&&d==='earth')return.5;if(a==='earth'&&d==='wind')return 1.5;
  return 1;
}

// â”€â”€â”€ SKILL DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sk(id,nm,el,dmg,cd,desc,stat,syn,p={}){return{id,name:nm,element:el,dmg,cd,desc,status:stat,synergy:syn,tags:p.tags||[],...p};}
const POOL={
 fire:{lmb:[
  sk('fl1','Feuerball','fire',30,.55,'Explodiert.','BURN 8/s','ğŸ”¥>ğŸŒ¿',{t:'proj',speed:490,r:9,aoe:38,burn:{d:8,dur:3},tags:['PROJEKTIL']}),
  sk('fl2','Flammenwerfer','fire',16,.1,'Kegelstrahl.','BURN 12/s','Nahkampf.',{t:'beam',range:130,cA:.46,burn:{d:12,dur:2},tags:['STRAHL']}),
  sk('fl3','Funkenflug','fire',13,.65,'4 Funken.','BURN 5/s','Streuung.',{t:'multi',cnt:4,spr:.5,speed:415,r:7,burn:{d:5,dur:2},tags:['STREUUNG']}),
 ],rmb:[
  sk('fr1','Pyro-Schlag','fire',88,8,'Explosion.','BURN 15/s','+WÃ¤nde.',{t:'proj',speed:200,r:22,aoe:88,burn:{d:15,dur:4},tags:['AUFGELADEN']}),
  sk('fr2','Drachenatem','fire',22,7,'Langer Kegel.','BURN 10/s+KB','Abstand.',{t:'beam',range:310,cA:.17,kb:110,burn:{d:10,dur:3},tags:['KANAL']}),
  sk('fr3','Meteor-Ruf','fire',115,9,'1.5s Delay.','BURN+Stun','Verheerend.',{t:'daoe',delay:1.5,r:85,burn:{d:15,dur:4},stun:.8,tags:['VERZÃ–GERT']}),
 ],active:[
  sk('fa1','Phoenix-Dash','fire',28,9,'Dash+Feuerspur.','BURN 8/s','I-Frames.',{t:'dashSkill',range:190,burn:{d:8,dur:3},tags:['DASH']}),
  sk('fa2','Hitzewelle','fire',55,11,'360Â° Explosion.','BURN+KB','Nahkampf.',{t:'aoe',r:115,kb:155,burn:{d:10,dur:2},tags:['360Â°']}),
  sk('fa3','Feuerwand','fire',0,10,'Zone 5s.','BURN solange drin','Barriere.',{t:'wall',ww:220,wh:14,burn:{d:12},life:5,tags:['TERRAIN']}),
 ],passive:[
  sk('fp1','Inneres Feuer','fire',0,0,'<30%HP â†’ +50%.','+50% Dmg','Glaskanone.',{t:'passive',pid:'innerfire'}),
  sk('fp2','Brandstifter','fire',0,0,'Crits +50% Burn.','+50% Burn','DPS.',{t:'passive',pid:'brand'}),
  sk('fp3','Aschenpakt','fire',0,0,'5% Chance Burn.','5%â†’Burn','Burst.',{t:'passive',pid:'asche'}),
 ]},
 water:{lmb:[
  sk('wl1','Wasser-Proj','water',21,.60,'Prallt ab.','NASS','ğŸ’§>ğŸ”¥',{t:'proj',speed:350,r:10,bounce:true,tags:['PRALL']}),
  sk('wl2','Blase','water',17,.70,'Homing.','Heilt +10HP','Immer.',{t:'proj',speed:200,r:12,homing:true,healHit:10,tags:['HOMING']}),
  sk('wl3','Peitsche','water',24,.65,'Nahkampf.','Slow+Heilt +6','Melee.',{t:'beam',range:105,cA:.6,slow:{f:.35,dur:2},healHit:6,tags:['NAHKAMPF']}),
 ],rmb:[
  sk('wr1','Tsunami','water',55,10,'Breite Welle.','KB 200','Pusher.',{t:'proj',speed:360,r:30,kb:200,tags:['WELLE']}),
  sk('wr2','Hochdruck','water',50,8,'Pierce.','Slow 50%','Anti-Alles.',{t:'beam',range:380,cA:.09,pierce:true,slow:{f:.5,dur:3},tags:['PIERCE']}),
  sk('wr3','Heil-Bombe','water',34,10,'AoE Heilung.','Heilt +35','Dual.',{t:'proj',speed:285,r:20,aoe:65,healHit:35,tags:['HEILUNG']}),
 ],active:[
  sk('wa1','Geysir','water',44,10,'Stun 1.5s.','STUN 1.5s','Setup.',{t:'aoe',r:58,stun:1.5,tags:['STUN']}),
  sk('wa2','Spiegel','water',0,13,'Reflektiert.','REFLEKTION','Konter.',{t:'buff',reflectDur:3,tags:['SCHILD']}),
  sk('wa3','Cleanse','water',0,12,'Entfernt Debuffs.','Cleanse alles','Konter.',{t:'buff',cleanse:true,tags:['CLEANSE']}),
 ],passive:[
  sk('wp1','Fluss','water',0,0,'CD -15%.','CDs -15%','Utility.',{t:'passive',pid:'fluss',cdReduce:.15}),
  sk('wp2','Schnell','water',0,0,'+20% Speed.','+20%','Kite.',{t:'passive',pid:'rutsch',spdMult:1.2}),
  sk('wp3','Regen','water',0,0,'+3HP/s.','+3HP/s','Sustain.',{t:'passive',pid:'hregen',hpRegen:3}),
 ]},
 earth:{lmb:[
  sk('el1','Felsbrocken','earth',38,.90,'Bogen+Stun.','STUN 0.8s','Ãœber Walls.',{t:'proj',speed:320,r:14,arc:true,stun:.8,tags:['BOGEN']}),
  sk('el2','Steinfaust','earth',42,.90,'Nahkampf KB.','KB 175','Interrupt.',{t:'aoe',r:86,kb:175,tags:['NAHKAMPF']}),
  sk('el3','Kiesel','earth',14,.80,'5 Steine.','kein Status','DPS.',{t:'multi',cnt:5,spr:.55,speed:335,r:7,tags:['STREUUNG']}),
 ],rmb:[
  sk('er1','Stampfer','earth',60,10,'Stun AoE.','STUN 2s','CC.',{t:'aoe',r:120,stun:2,tags:['AOE']}),
  sk('er2','Boulder','earth',68,9,'Rollend.','KB 200','Ramme.',{t:'dashSkill',range:265,kb:200,tags:['DASH']}),
  sk('er3','Stalaktit','earth',74,9,'0.8s Delay.','AIRBORNE 2s','Kombo.',{t:'daoe',delay:.8,r:50,stun:2,tags:['VERZÃ–GERT']}),
 ],active:[
  sk('ea1','Barrikade','earth',0,11,'Wand 200HP.','Blockt 200','Deckung.',{t:'wall',ww:12,wh:100,hp:200,life:6,tags:['TERRAIN']}),
  sk('ea2','Treibsand','earth',10,10,'-70% Zone.','SLOW 70%','Setup.',{t:'zone',r:88,slow:{f:.7},life:5,tags:['ZONE']}),
  sk('ea3','RÃ¼stung','earth',0,12,'Schild 100HP.','Schild 100','Tank.',{t:'buff',shield:100,tags:['SCHILD']}),
 ],passive:[
  sk('ep1','Standhaft','earth',0,0,'KB-Immun.','KB-Immun','Charge.',{t:'passive',pid:'standhaft',kbImmune:true}),
  sk('ep2','Festung','earth',0,0,'-18% Dmg.','-18%','Tank.',{t:'passive',pid:'fest',dmgReduce:.18}),
  sk('ep3','Splitter','earth',0,0,'12 Thorns.','12 Thorns','Rache.',{t:'passive',pid:'splitter',thorns:12}),
 ]},
 wind:{lmb:[
  sk('wil1','Windklinge','wind',17,.45,'Schnell Pierce.','Pierce','Spam.',{t:'proj',speed:665,r:7,pierce:true,tags:['SCHNELL']}),
  sk('wil2','LuftstoÃŸ','wind',4,.50,'Nur KB.','KB 220','Combo.',{t:'aoe',r:92,kb:220,tags:['KB']}),
  sk('wil3','Bumerang','wind',20,.70,'2Ã— Treffer.','2Ã— KB','RÃ¼ckkehr.',{t:'proj',speed:405,r:9,boomerang:true,tags:['RÃœCKKEHR']}),
 ],rmb:[
  sk('wir1','Tornado','wind',64,9,'Airborne 2s.','AIRBORNE 2s','Setup.',{t:'proj',speed:285,r:18,stun:2,tags:['AIRBORNE']}),
  sk('wir2','Vakuum','wind',38,10,'Zieht alle.','PULL 200','Feuer-Combo.',{t:'aoe',r:140,pull:200,tags:['PULL']}),
  sk('wir3','Schallmauer','wind',48,8,'Dash durch.','KB 150','Escape.',{t:'dashSkill',range:335,kb:150,tags:['DASH']}),
 ],active:[
  sk('wia1','RÃ¼ckenwind','wind',0,12,'+50% Speed.','Speed +50%','Kite.',{t:'buff',speedBuff:4,tags:['SPEED']}),
  sk('wia2','Windmauer','wind',0,12,'Blockt Proj.','Projekte block','Konter.',{t:'wall',ww:12,wh:100,windWall:true,life:5,tags:['BLOCK']}),
  sk('wia3','Tausch','wind',20,14,'Pos-Tausch.','Tausch','Riskant.',{t:'special',swap:true,tags:['SWAP']}),
 ],passive:[
  sk('wip1','Leicht','wind',0,0,'Dash -35%.','Dash -35%','MobilitÃ¤t.',{t:'passive',pid:'leicht',dashMult:.65}),
  sk('wip2','Statik','wind',0,0,'+40% nach 1s.','Bewegen +40%','Stark.',{t:'passive',pid:'statik'}),
  sk('wip3','BÃ¶e','wind',0,0,'20% Dodge.','20% Dodge','Phase 3.',{t:'passive',pid:'boe',dodge:.2}),
 ]},
 nature:{lmb:[
  sk('nl1','Dornen-Pfeil','nature',16,.55,'Gift-DoT.','GIFT 7/s','ğŸŒ¿>ğŸ’§',{t:'proj',speed:465,r:8,poison:{d:7,dur:4},tags:['GIFT']}),
  sk('nl2','Gift-Spucke','nature',11,.70,'PfÃ¼tze.','PfÃ¼tze GIFT','Zone.',{t:'proj',speed:325,r:10,poisonZ:true,tags:['PFÃœTZE']}),
  sk('nl3','Blattklinge','nature',14,.70,'Homing.','kein Status','Sicher.',{t:'proj',speed:225,r:9,homing:true,tags:['HOMING']}),
 ],rmb:[
  sk('nr1','Sporen','nature',30,10,'Gift AoE.','GIFT 10/s','Zone.',{t:'aoe',r:100,poison:{d:10,dur:5},tags:['GIFT']}),
  sk('nr2','Wurzel','nature',25,8,'Root 1.5s.','ROOT 1.5s','Setup.',{t:'proj',speed:345,r:12,root:1.5,tags:['ROOT']}),
  sk('nr3','Hook','nature',34,9,'Zieht ran.','Root 0.5s','Aggressiv.',{t:'hook',root:.5,dmg:34,tags:['HOOK']}),
 ],active:[
  sk('na1','Root','nature',18,10,'Root 3s.','ROOT 3s','CC.',{t:'special',rootT:3,tags:['ROOT']}),
  sk('na2','Rankenwand','nature',0,11,'Wand Gift+Slow.','GIFT+SLOW','Zoning.',{t:'wall',ww:12,wh:110,poison:{d:8},slow:{f:.5},life:5,tags:['TERRAIN']}),
  sk('na3','Heil-BlÃ¼te','nature',0,14,'Heil Zone.','6HP/2s','Regen.',{t:'zone',r:60,healZ:{a:6,iv:2},life:8,tags:['HEILUNG']}),
 ],passive:[
  sk('np1','Dornen','nature',0,0,'10 Thorns.','10 Thorns','Stack.',{t:'passive',pid:'dornen',thorns:10}),
  sk('np2','Photo','nature',0,0,'Still 8HP/s.','Stillâ†’8HP/s','Regen.',{t:'passive',pid:'photo',photoRegen:8}),
  sk('np3','Symbiose','nature',0,0,'Heilung +30%.','Heilung +30%','Stack.',{t:'passive',pid:'sym',healBonus:1.3}),
 ]},
 light:{lmb:[
  sk('lil1','Laser','light',24,.50,'Hitscan.','sofort','PrÃ¤zise.',{t:'hitscan',range:350,tags:['SOFORT']}),
  sk('lil2','Licht-Orb','light',19,.65,'Langsam AoE.','AoE 30','Abdeckung.',{t:'proj',speed:205,r:13,pulseAoe:30,tags:['PULS']}),
  sk('lil3','Smite','light',32,.70,'Blitz Delay.','BLIND 1.2s','Gruppe.',{t:'daoe',delay:.5,r:44,blind:1.2,tags:['BLITZ']}),
 ],rmb:[
  sk('lir1','Blend-Granate','light',21,9,'Blind AoE.','BLIND 3s','Konter.',{t:'aoe',r:108,blind:3,tags:['BLIND']}),
  sk('lir2','Lichtschwert','light',78,10,'Nahkampf.','KB 120','Dmg.',{t:'aoe',r:115,kb:120,tags:['NAHKAMPF']}),
  sk('lir3','Prisma','light',35,9,'3 Strahlen.','3Ã— Dmg','Multi.',{t:'multi',cnt:3,speed:465,r:9,tags:['SPLIT']}),
 ],active:[
  sk('lia1','Engel','light',0,12,'Schild 150.','Schild 150','Tank.',{t:'buff',shield:150,tags:['SCHILD']}),
  sk('lia2','Flash','light',0,11,'Sofort-Blink.','Teleport','Escape.',{t:'special',blink:true,tags:['BLINK']}),
  sk('lia3','Cleanse','light',0,10,'Cleanse CC.','Cleanse all','Konter.',{t:'buff',cleanse:true,tags:['CLEANSE']}),
 ],passive:[
  sk('lip1','Hoffnung','light',0,0,'Heilung +30%.','+30%','Stack.',{t:'passive',pid:'hoff',healBonus:1.3}),
  sk('lip2','Solar','light',0,0,'R-CD -30%.','R-CD -30%','Ulti.',{t:'passive',pid:'solar',fusionCDR:.3}),
  sk('lip3','Blendung','light',0,0,'Angreifer blind.','Angreifer BLIND','Def.',{t:'passive',pid:'blend2'}),
 ]},
 darkness:{lmb:[
  sk('dl1','Schatten-Bolzen','darkness',17,.60,'Distanz-Skala.','LIFESTEAL +8','ğŸŒ‘>âœ¨',{t:'proj',speed:425,r:9,rangeMult:2.5,healHit:8,tags:['LIFESTEAL']}),
  sk('dl2','Sense','darkness',26,.65,'Nahkampf.','LIFESTEAL +10','Sustain.',{t:'aoe',r:110,healHit:10,tags:['NAHKAMPF']}),
  sk('dl3','Leeren-Kugel','darkness',20,.70,'Durch WÃ¤nde.','LIFESTEAL +6','Walls.',{t:'proj',speed:385,r:10,throughWalls:true,healHit:6,tags:['DURCH-WÃ„NDE']}),
 ],rmb:[
  sk('dr1','Seelen-Raub','darkness',16,10,'Drain-Strahl.','LIFESTEAL 100%','Sustain.',{t:'beam',range:265,healHit:16,tags:['DRAIN']}),
  sk('dr2','Schrei','darkness',24,11,'Fear AoE.','FEAR 2.5s','Abstand.',{t:'aoe',r:125,fear:2.5,tags:['FEAR']}),
  sk('dr3','Schatten-Sprung','darkness',44,9,'Teleport+Krit.','CRIT 2Ã—','Backstab.',{t:'special',teleportBehind:true,critBuff:2,tags:['TELEPORT']}),
 ],active:[
  sk('da1','Stealth','darkness',0,14,'3sâ†’Krit 2.5Ã—.','STEALTHâ†’KRIT','Opener.',{t:'buff',stealth:true,critMult:2.5,tags:['STEALTH']}),
  sk('da2','Verderbnis','darkness',10,11,'Zone Dmg+Heal.','12Dmg+8Heal/s','Sustain.',{t:'zone',r:88,dmgTick:12,healTick:8,life:5,tags:['ZONE']}),
  sk('da3','Fluch','darkness',0,12,'Boss -50% 6s.','Boss -50%','Konter.',{t:'special',curseE:{dur:6,dr:.5},tags:['FLUCH']}),
 ],passive:[
  sk('dp1','Vampir','darkness',0,0,'5% Lifesteal.','5% Lifesteal','Sustain.',{t:'passive',pid:'vamp',lifesteal:.05}),
  sk('dp2','Exek','darkness',0,0,'<15% +80%.','<15%â†’+80%','Finisher.',{t:'passive',pid:'exek'}),
  sk('dp3','Nacht','darkness',0,0,'Dashâ†’Stealth.','Dash Stealth','Opener.',{t:'passive',pid:'nacht'}),
 ]},
};

// â”€â”€â”€ FUSIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FUS={
 'fire+water':{n:'Dampfwalze',e:'ğŸ’¨',el:'fire',d:'AoE 160 Blind 2s + Burn.',fx:'steamRoll',cd:20},
 'fire+earth':{n:'Vulkan',e:'ğŸŒ‹',el:'fire',d:'Vulkanzone 8s.',fx:'volcano',cd:22},
 'fire+wind':{n:'Flammen-Tornado',e:'ğŸŒ€',el:'fire',d:'Wandernder Tornado 5s.',fx:'fireTornado',cd:21},
 'fire+nature':{n:'Brennende Ranken',e:'ğŸŒ¿',el:'fire',d:'Root 5s + Burn 20/s.',fx:'fireVines',cd:20},
 'fire+light':{n:'Supernova',e:'âš¡',el:'light',d:'AoE 200px 130Dmg + Blind.',fx:'supernova',cd:22},
 'fire+darkness':{n:'Schwarze Flamme',e:'ğŸ–¤',el:'fire',d:'True 200 Dmg.',fx:'blackFlame',cd:20},
 'water+earth':{n:'Erdrutsch',e:'ğŸŒŠ',el:'water',d:'Stun 3s + Slow 70%.',fx:'mudslide',cd:21},
 'water+wind':{n:'Blizzard',e:'ğŸŒ¨',el:'water',d:'Freeze alle 3s.',fx:'blizzard',cd:22},
 'water+nature':{n:'Sumpf',e:'ğŸŒ±',el:'nature',d:'Heil-Zone 6s + Slow.',fx:'lifeSwamp',cd:20},
 'water+light':{n:'Heiliges Wasser',e:'âœ¨',el:'light',d:'3s Invul + Dmg.',fx:'holyWater',cd:22},
 'water+darkness':{n:'Kraken',e:'ğŸ™',el:'darkness',d:'180 Dmg + Stun.',fx:'kraken',cd:21},
 'earth+wind':{n:'Sandsturm',e:'ğŸŒª',el:'earth',d:'Blind 5s + DoT.',fx:'sandstorm',cd:21},
 'earth+nature':{n:'Weltenbaum',e:'ğŸŒ³',el:'nature',d:'Riesenwand + Heil.',fx:'worldTree',cd:22},
 'earth+light':{n:'Diamant-Haut',e:'ğŸ’',el:'light',d:'5s Invul.',fx:'diamondSkin',cd:24},
 'earth+darkness':{n:'Zombie-HÃ¤nde',e:'ğŸ’€',el:'darkness',d:'Root 4s + 120 Dmg.',fx:'zombieHands',cd:21},
 'wind+nature':{n:'Pollenflug',e:'ğŸŒ¸',el:'nature',d:'Alle schlafen 3s.',fx:'pollenSleep',cd:20},
 'wind+light':{n:'Licht-Speed',e:'ğŸ’«',el:'light',d:'Slow 80% 4s.',fx:'lightSpeed',cd:21},
 'wind+darkness':{n:'Schatten-Schritt',e:'ğŸŒ‘',el:'darkness',d:'5Ã— Combo 200 Dmg.',fx:'shadowStep',cd:21},
 'nature+light':{n:'Mondlichtung',e:'ğŸŒ™',el:'light',d:'Invul 4s + Stun 4s.',fx:'moonClear',cd:24},
 'nature+darkness':{n:'Seuche',e:'â˜ ',el:'nature',d:'Gift 8s + Burn.',fx:'plague',cd:20},
 'light+darkness':{n:'Eclipse',e:'ğŸŒ—',el:'darkness',d:'220 True Dmg global.',fx:'eclipse',cd:24},
};
function getFus(a,b){return FUS[[a,b].sort().join('+')]||null;}

// â”€â”€â”€ 7 ELEMENTAL BOSSES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BOSS_DEFS={
 fire:{
  name:'Inferno-Drake',boss_el:'fire',emoji:'ğŸ‰',hp:1800,r:50,spd:88,
  color:'#ff4500',glow:'#ff6b1a',
  desc:'Feurige Bestie â€” Schwach gegen Wasser',
  phases:[
   {hp:1800,atkPattern:'spread3',spd:88,chargeCD:9,minionEl:'fire',minionHP:70},
   {hp:900, atkPattern:'spread5+fire',spd:125,chargeCD:6,minionEl:'fire',minionHP:70},
   {hp:400, atkPattern:'spread7+meteor',spd:165,chargeCD:4,minionEl:'fire',minionHP:70},
  ],
  specialAtks:['fireBreath','meteors','firePillar','flameRing'],
 },
 water:{
  name:'Tidal-Leviathan',boss_el:'water',emoji:'ğŸŒŠ',hp:2000,r:56,spd:72,
  color:'#1565c0',glow:'#42a5f5',
  desc:'Tiefsee-Titan â€” Schwach gegen Natur',
  phases:[
   {hp:2000,atkPattern:'homing3',spd:72,chargeCD:11,minionEl:'water',minionHP:75},
   {hp:1000,atkPattern:'homing5+wave',spd:105,chargeCD:8,minionEl:'water',minionHP:75},
   {hp:450, atkPattern:'tidal+ring',spd:140,chargeCD:5,minionEl:'water',minionHP:75},
  ],
  specialAtks:['tidalWave','waterPrison','healSelf','vortex'],
 },
 earth:{
  name:'Stein-Koloss',boss_el:'earth',emoji:'ğŸ—¿',hp:2400,r:58,spd:65,
  color:'#5d4037',glow:'#a3a86e',
  desc:'Uralter Kolos â€” Schwach gegen Wind',
  phases:[
   {hp:2400,atkPattern:'boulder',spd:65,chargeCD:12,minionEl:'earth',minionHP:90},
   {hp:1200,atkPattern:'quake+spikes',spd:92,chargeCD:8,minionEl:'earth',minionHP:90},
   {hp:500, atkPattern:'quake+spikes+meteors',spd:125,chargeCD:5,minionEl:'earth',minionHP:90},
  ],
  specialAtks:['groundSlam','rockSpikes','stoneWalls','quakeShockwave'],
 },
 wind:{
  name:'Sturm-Geist',boss_el:'wind',emoji:'ğŸŒª',hp:1600,r:46,spd:105,
  color:'#01579b',glow:'#4fc3f7',
  desc:'Ã„therisches Wesen â€” Schwach gegen Erde',
  phases:[
   {hp:1600,atkPattern:'fast5',spd:105,chargeCD:8,minionEl:'wind',minionHP:60},
   {hp:800, atkPattern:'fast8+tornado',spd:148,chargeCD:5,minionEl:'wind',minionHP:60},
   {hp:350, atkPattern:'fast12+vacuum',spd:190,chargeCD:3,minionEl:'wind',minionHP:60},
  ],
  specialAtks:['windBarrage','tornadoSpin','vacuum','airBurst'],
 },
 nature:{
  name:'Uralter Baum',boss_el:'nature',emoji:'ğŸŒ³',hp:2200,r:55,spd:58,
  color:'#1b5e20',glow:'#4ade80',
  desc:'Lebendige Natur â€” Schwach gegen Feuer',
  phases:[
   {hp:2200,atkPattern:'poison3',spd:58,chargeCD:14,minionEl:'nature',minionHP:80},
   {hp:1100,atkPattern:'poison5+roots',spd:82,chargeCD:9,minionEl:'nature',minionHP:80},
   {hp:500, atkPattern:'spore+root+heal',spd:108,chargeCD:6,minionEl:'nature',minionHP:80},
  ],
  specialAtks:['rootCage','sporeBurst','natureSeal','healing'],
 },
 light:{
  name:'Solar-PhÃ¶nix',boss_el:'light',emoji:'ğŸ¦…',hp:1900,r:50,spd:80,
  color:'#f57f17',glow:'#fde68a',
  desc:'Strahlender WÃ¤chter â€” Schwach gegen Dunkelheit',
  phases:[
   {hp:1900,atkPattern:'laser3',spd:80,chargeCD:10,minionEl:'light',minionHP:65},
   {hp:950, atkPattern:'laser5+blind',spd:115,chargeCD:7,minionEl:'light',minionHP:65},
   {hp:400, atkPattern:'fullBlast+resurrection',spd:150,chargeCD:4,minionEl:'light',minionHP:65},
  ],
  specialAtks:['solarFlare','blindPulse','holyBeam','reviveMinions'],
 },
 darkness:{
  name:'Void-Harbinger',boss_el:'darkness',emoji:'ğŸ‘',hp:2100,r:52,spd:78,
  color:'#4a0072',glow:'#a855f7',
  desc:'Dunkler Herrscher â€” Schwach gegen Licht',
  phases:[
   {hp:2100,atkPattern:'shadow3',spd:78,chargeCD:10,minionEl:'darkness',minionHP:75},
   {hp:1050,atkPattern:'shadow5+fear',spd:112,chargeCD:7,minionEl:'darkness',minionHP:75},
   {hp:450, atkPattern:'drain+curse+portal',spd:150,chargeCD:4,minionEl:'darkness',minionHP:75},
  ],
  specialAtks:['shadowBeam','fearShout','voidPortal','lifeSteal'],
 },
};

// â”€â”€â”€ LEVEL DEFINITIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LEVELS=[
 {id:0,name:'Feuer-Tempel',emoji:'ğŸ”¥',boss:'fire',bg:'#0d0500',gridCol:'#180800',
  difficulty:'AnfÃ¤nger',pillarsLayout:'open',guardians:['fire'],minionWaves:2},
 {id:1,name:'Tiefsee',emoji:'ğŸŒŠ',boss:'water',bg:'#020810',gridCol:'#041028',
  difficulty:'Leicht',pillarsLayout:'ring',guardians:['water','wind'],minionWaves:2},
 {id:2,name:'Steinburg',emoji:'ğŸª¨',boss:'earth',bg:'#080604',gridCol:'#120e08',
  difficulty:'Mittel',pillarsLayout:'maze',guardians:['earth','nature'],minionWaves:3},
 {id:3,name:'Sturmgipfel',emoji:'âš¡',boss:'wind',bg:'#020610',gridCol:'#040c1e',
  difficulty:'Mittel',pillarsLayout:'sparse',guardians:['wind','fire'],minionWaves:3},
 {id:4,name:'Urwald',emoji:'ğŸŒ¿',boss:'nature',bg:'#020a03',gridCol:'#041208',
  difficulty:'Schwer',pillarsLayout:'dense',guardians:['nature','water','earth'],minionWaves:4},
 {id:5,name:'Lichttempel',emoji:'âœ¨',boss:'light',bg:'#0c0a02',gridCol:'#1a1404',
  difficulty:'Schwer',pillarsLayout:'cross',guardians:['light','fire','wind'],minionWaves:4},
 {id:6,name:'Schattenvoid',emoji:'ğŸŒ‘',boss:'darkness',bg:'#050008',gridCol:'#0c0016',
  difficulty:'Extrem',pillarsLayout:'chaos',guardians:['darkness','light','nature','fire'],minionWaves:5},
];

function buildPillarsForLayout(layout){
  const cx=GW/2,cy=GH/2;
  const configs={
   open:[
    {x:cx-25,y:cy-25,w:50,h:50},{x:PAD+70,y:PAD+65,w:40,h:40},
    {x:GW-PAD-110,y:PAD+65,w:40,h:40},{x:PAD+70,y:GH-PAD-105,w:40,h:40},
    {x:GW-PAD-110,y:GH-PAD-105,w:40,h:40},
   ],
   ring:[
    {x:cx-25,y:cy-25,w:50,h:50},
    {x:cx-180,y:cy-22,w:44,h:44},{x:cx+136,y:cy-22,w:44,h:44},
    {x:cx-22,y:cy-165,w:44,h:44},{x:cx-22,y:cy+121,w:44,h:44},
    {x:PAD+65,y:PAD+60,w:36,h:36},{x:GW-PAD-101,y:PAD+60,w:36,h:36},
    {x:PAD+65,y:GH-PAD-96,w:36,h:36},{x:GW-PAD-101,y:GH-PAD-96,w:36,h:36},
   ],
   maze:[
    {x:cx-25,y:cy-25,w:50,h:50},
    {x:cx-200,y:cy-20,w:44,h:44},{x:cx+156,y:cy-20,w:44,h:44},
    {x:cx-20,y:cy-175,w:44,h:44},{x:cx-20,y:cy+131,w:44,h:44},
    {x:PAD+70,y:GH/2-18,w:36,h:36},{x:GW-PAD-106,y:GH/2-18,w:36,h:36},
    {x:GW/2-18,y:PAD+65,w:36,h:36},{x:GW/2-18,y:GH-PAD-101,w:36,h:36},
    {x:PAD+68,y:PAD+64,w:38,h:38},{x:GW-PAD-106,y:PAD+64,w:38,h:38},
    {x:PAD+68,y:GH-PAD-102,w:38,h:38},{x:GW-PAD-106,y:GH-PAD-102,w:38,h:38},
   ],
   sparse:[
    {x:cx-22,y:cy-22,w:44,h:44},
    {x:PAD+90,y:GH/2-20,w:36,h:40},{x:GW-PAD-126,y:GH/2-20,w:36,h:40},
    {x:GW/2-18,y:PAD+80,w:40,h:36},{x:GW/2-18,y:GH-PAD-116,w:40,h:36},
   ],
   dense:[
    {x:cx-25,y:cy-25,w:50,h:50},
    {x:cx-195,y:cy-20,w:44,h:44},{x:cx+151,y:cy-20,w:44,h:44},
    {x:cx-20,y:cy-172,w:44,h:44},{x:cx-20,y:cy+128,w:44,h:44},
    {x:PAD+70,y:GH/2-20,w:36,h:40},{x:GW-PAD-106,y:GH/2-20,w:36,h:40},
    {x:GW/2-20,y:PAD+65,w:40,h:36},{x:GW/2-20,y:GH-PAD-101,w:40,h:36},
    {x:cx-130,y:cy-130,w:30,h:30},{x:cx+100,y:cy-130,w:30,h:30},
    {x:cx-130,y:cy+100,w:30,h:30},{x:cx+100,y:cy+100,w:30,h:30},
   ],
   cross:[
    {x:cx-25,y:cy-25,w:50,h:50},
    {x:cx-15,y:PAD+55,w:30,h:GH/2-110},
    {x:cx-15,y:GH/2+55,w:30,h:GH/2-110},
    {x:PAD+55,y:cy-15,w:GW/2-110,h:30},
    {x:GW/2+55,y:cy-15,w:GW/2-110,h:30},
   ],
   chaos:[
    {x:cx-25,y:cy-25,w:50,h:50},
    {x:cx-190,y:cy-20,w:44,h:44},{x:cx+146,y:cy-20,w:44,h:44},
    {x:cx-20,y:cy-170,w:44,h:44},{x:cx-20,y:cy+126,w:44,h:44},
    {x:cx-100,y:cy-90,w:32,h:32},{x:cx+68,y:cy-90,w:32,h:32},
    {x:cx-100,y:cy+58,w:32,h:32},{x:cx+68,y:cy+58,w:32,h:32},
    {x:PAD+65,y:PAD+60,w:38,h:38},{x:GW-PAD-103,y:PAD+60,w:38,h:38},
    {x:PAD+65,y:GH-PAD-98,w:38,h:38},{x:GW-PAD-103,y:GH-PAD-98,w:38,h:38},
   ],
  };
  return(configs[layout]||configs.ring).map(p=>({...p,temp:false}));
}
// â”€â”€â”€ GAME STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let gameMode='solo'; // 'solo' | 'host' | 'guest'
let peer=null, conn=null, isHost=false;
let currentLevel=0, completedLevels=[];
let loadouts=[null,null];
let draftState={step:0,curPlayer:0,picks:[[],[],[]]};
let rngS=Date.now()|0;
function sr(){rngS=(rngS*1664525+1013904223)>>>0;return rngS/4294967296;}
function pickN(a,n){const b=[...a];for(let i=b.length-1;i>0;i--){const j=Math.floor(sr()*(i+1));[b[i],b[j]]=[b[j],b[i]];}return b.slice(0,n);}
function rndFrom(a){return a[Math.floor(sr()*a.length)];}

// â”€â”€â”€ GAME OBJECTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let cv,ctx,running=false,animId=null,lastT=0;
let players=[],enemies=[],projs=[],parts=[],floats=[],fieldFx=[],pillars=[];
let shakeX=0,shakeY=0,shakeT=0,shakeA=0;
let ann={text:'',t:0,max:0};
let gamePhase=0,phaseCD=0;
let levelTimer=0,killCount=0;
const keys={};let mx=GW/2,my=GH/2;
let p2autoT=0;
let lastBossHp=9999;

// â”€â”€â”€ MENU NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden'));document.getElementById(id).classList.remove('hidden');}
function goMenu(){cleanupPeer();if(animId){cancelAnimationFrame(animId);animId=null;}running=false;removeListeners();hideTip();showScreen('menu');}
function goSolo(){gameMode='solo';buildLevelGrid();showScreen('levelselect');}
function retryLevel(){startDraft();}

// â”€â”€â”€ LEVEL SELECT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildLevelGrid(){
  const g=document.getElementById('levelsGrid');g.innerHTML='';
  LEVELS.forEach((lv,i)=>{
    const done=completedLevels.includes(i),locked=i>0&&!completedLevels.includes(i-1),cur=i===currentLevel;
    const bd=BOSS_DEFS[lv.boss];
    const c=document.createElement('div');c.className='lcard'+(locked?' locked':'')+(done?' completed':'')+(cur?' current':'');
    c.style.cssText=`border-color:${EL[lv.boss].c}${locked?'22':'55'};`;
    c.innerHTML=`<div class="lem">${lv.emoji}</div><div class="lname" style="color:${EL[lv.boss].c}">${lv.name}</div><div class="ldiff" style="color:${EL[lv.boss].c}88">${lv.difficulty}</div>${done?'<div class="lbadge">âœ“</div>':''}`;
    if(!locked)c.onclick=()=>{currentLevel=i;startDraft();};
    g.appendChild(c);
  });
}

// â”€â”€â”€ LOBBY (PeerJS) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function genCode(){let s='';for(let i=0;i<6;i++)s+='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'[Math.floor(Math.random()*36)];return s;}

function goCreateLobby(){
  gameMode='host';isHost=true;showScreen('lobbyCreate');
  const code=genCode();document.getElementById('roomCodeDisplay').textContent=code;
  try{
    peer=new Peer('EC-'+code,{debug:0});
    peer.on('open',()=>{document.getElementById('hostStatus').textContent='Warte auf Mitspieler...';});
    peer.on('connection',c=>{
      conn=c;
      document.getElementById('hostDot').className='status-dot connected';
      document.getElementById('hostStatus').textContent='âœ“ Verbunden! Starte Draft...';
      c.on('open',()=>{setTimeout(()=>{currentLevel=0;buildLevelGrid();startDraftOnline();},1200);});
      c.on('data',onNetData);
      c.on('close',()=>{if(running)showAnn('ğŸ”´ Verbindung getrennt',4);});
    });
    peer.on('error',e=>{document.getElementById('hostStatus').textContent='âš  Fehler: '+e.type;});
  }catch(e){document.getElementById('hostStatus').textContent='PeerJS nicht verfÃ¼gbar â€“ Offline-Modus';}
}

function goJoinLobby(){gameMode='guest';isHost=false;showScreen('lobbyJoin');}

function doJoin(){
  const code=document.getElementById('joinCodeInp').value.trim().toUpperCase();
  if(code.length<4){document.getElementById('joinStatus').textContent='Code zu kurz';return;}
  document.getElementById('joinDot').className='status-dot waiting';
  document.getElementById('joinStatus').textContent='Verbinde...';
  try{
    peer=new Peer('EC-GUEST-'+Math.floor(Math.random()*99999),{debug:0});
    peer.on('open',()=>{
      conn=peer.connect('EC-'+code);
      conn.on('open',()=>{
        document.getElementById('joinDot').className='status-dot connected';
        document.getElementById('joinStatus').textContent='âœ“ Verbunden!';
        conn.on('data',onNetData);
        conn.on('close',()=>{if(running)showAnn('ğŸ”´ Host getrennt',4);});
      });
      conn.on('error',e=>{document.getElementById('joinStatus').textContent='âš  '+e;});
    });
    peer.on('error',e=>{document.getElementById('joinStatus').textContent='âš  Fehler: '+e.type;});
  }catch(e){document.getElementById('joinStatus').textContent='PeerJS nicht verfÃ¼gbar';}
}

function onNetData(d){
  if(d.type==='input'&&gameMode==='host'&&players[1]){
    const p=players[1];if(d.keys)Object.assign(p._netKeys||{},d.keys);
  }
  if(d.type==='start'){currentLevel=d.level;startDraft();}
}

function startDraftOnline(){showScreen('draft');initDraft();}
function lobbyCancel(){cleanupPeer();showScreen('menu');}
function cleanupPeer(){if(conn)try{conn.close();}catch(e){}if(peer)try{peer.destroy();}catch(e){}conn=null;peer=null;}

// â”€â”€â”€ DRAFT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initDraft(){
  draftState={step:0,curPlayer:0,picks:[[],[],[]]};
  loadouts=[null,null];rngS=Date.now()|0;
  const pl=gameMode==='solo'?1:2;
  document.getElementById('draftModeLbl').textContent=gameMode==='solo'?'SOLO Â· LEVEL '+(currentLevel+1)+'/7':'ONLINE CO-OP Â· LEVEL '+(currentLevel+1)+'/7';
  document.getElementById('btngo').classList.remove('rdy');
  document.getElementById('lrow').innerHTML='';
  showDraftStep();
}

const SL=['PHASE 1 â€” PRIMÃ„R','PHASE 2 â€” SEKUNDÃ„R','PHASE 3 â€” SEELE'];
function showDraftStep(){
  const{step,curPlayer}=draftState;
  const numP=gameMode==='solo'?1:2;
  document.getElementById('plabel').innerHTML=`<span style="color:${PC[curPlayer]}">SPIELER ${curPlayer+1}</span>`;
  document.getElementById('pstep').textContent=SL[step]+' â€” WÃ¤hle dein Element';
  const used=[];draftState.picks.forEach(a=>a.forEach(e=>e&&used.push(e)));
  const avail=ALL_EL.filter(e=>!used.includes(e));
  const pool=pickN(avail,3);
  const row=document.getElementById('cards');row.innerHTML='';
  pool.forEach((el,i)=>{
    const E=EL[el];const d=document.createElement('div');d.className='card';
    d.style.cssText=`border-color:${E.c}44;`;
    d.innerHTML=`<div class="cem">${E.e}</div><div class="cname" style="color:${E.c}">${E.n.toUpperCase()}</div><div class="crole">${ROLES[el]}</div>`;
    d.onclick=()=>pickCard(el,d);
    d.style.opacity='0';d.style.transform='translateY(10px)';
    setTimeout(()=>{d.style.transition='all .3s';d.style.opacity='1';d.style.transform='none';},50+i*80);
    row.appendChild(d);
  });
}

function pickCard(el,div){
  const{step,curPlayer}=draftState;
  draftState.picks[step][curPlayer]=el;
  document.querySelectorAll('.card').forEach(c=>c.classList.add('dim'));
  div.classList.remove('dim');div.classList.add('sel');
  div.style.borderColor=EL[el].c;div.style.boxShadow=`0 0 24px ${EL[el].c}55`;
  setTimeout(()=>{
    const numP=gameMode==='solo'?1:2;
    const other=curPlayer===0?1:0;
    if(numP>1&&!draftState.picks[step][other]){draftState.curPlayer=other;showDraftStep();}
    else{
      draftState.step++;draftState.curPlayer=0;
      if(draftState.step<3)showDraftStep();
      else{buildLoadouts();finalizeDraft();}
    }
  },540);
}

function buildLoadouts(){
  const{picks}=draftState;const numP=gameMode==='solo'?1:2;
  for(let p=0;p<numP;p++){
    const A=picks[0][p]||picks[0][0],B=picks[1][p]||picks[1][0],soul=picks[2][p]||picks[2][0];
    if(!A||!B||!soul)continue;
    loadouts[p]={elemA:A,elemB:B,soul,activeEl:'A',
      lmbA:rndFrom(POOL[A].lmb),lmbB:rndFrom(POOL[B].lmb),
      rmbA:rndFrom(POOL[A].rmb),rmbB:rndFrom(POOL[B].rmb),
      qSkill:rndFrom(POOL[A].active),eSkill:rndFrom(POOL[B].active),
      fusion:getFus(A,B),passive:rndFrom(POOL[soul].passive),
    };
  }
  // Solo P2 gets auto-build
  if(gameMode==='solo'&&!loadouts[1]){
    const A2='water',B2='earth',S2='nature';
    loadouts[1]={elemA:A2,elemB:B2,soul:S2,activeEl:'A',
      lmbA:rndFrom(POOL[A2].lmb),lmbB:rndFrom(POOL[B2].lmb),
      rmbA:rndFrom(POOL[A2].rmb),rmbB:rndFrom(POOL[B2].rmb),
      qSkill:rndFrom(POOL[A2].active),eSkill:rndFrom(POOL[B2].active),
      fusion:getFus(A2,B2),passive:rndFrom(POOL[S2].passive),ai:true,
    };
  }
}

function finalizeDraft(){
  const lv=LEVELS[currentLevel];
  const bd=BOSS_DEFS[lv.boss];
  let preview=``;
  for(let p=0;p<2;p++){const lo=loadouts[p];if(!lo)continue;const f=lo.fusion;preview+=`<div class="ls" style="border-color:${PC[p]}44"><span style="color:${PC[p]}">P${p+1}</span><span>${EL[lo.elemA].e}${EL[lo.elemB].e}${EL[lo.soul].e}</span>${f?`<span style="color:#c084fc;font-size:10px">${f.e}${f.n}</span>`:''}</div>`;}
  document.getElementById('plabel').textContent='BUILDS BEREIT';
  document.getElementById('pstep').innerHTML=`<span style="color:${EL[lv.boss].c}">GEGNER: ${bd.emoji} ${bd.name} (${bd.desc})</span>`;
  document.getElementById('cards').innerHTML='';document.getElementById('lrow').innerHTML=preview;
  document.getElementById('btngo').classList.add('rdy');
}

// â”€â”€â”€ START GAME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function makePlayer(p,lo){
  const pass=lo.passive;
  const startX=p===0?GW*.28:GW*.72,startY=GH*.78;
  return{id:p,x:startX,y:startY,r:16,hp:140,maxHp:140,
    spd:222*(pass?.spdMult||1),iframes:0,shield:0,invul:0,
    burnT:0,burnD:0,burnTick:0,poisonT:0,poisonTick:0,
    reflectT:0,speedBuffT:0,stealthOn:false,stealthCrit:false,critBuff:1,staticT:0,
    dmgReduce:pass?.dmgReduce||0,kbImmune:!!pass?.kbImmune,
    dodge:pass?.dodge||0,lifesteal:pass?.lifesteal||0,
    healBonus:pass?.healBonus||1,dashCDMult:pass?.dashMult||1,
    fusionCDR:pass?.fusionCDR||0,thorns:pass?.thorns||0,
    photoRegen:pass?.photoRegen||0,hpRegen:pass?.hpRegen||0,
    cds:{lmb:0,rmb:0,q:0,e:0,r:0,dash:0},chargeT:0,chargeHeld:false,alive:true,
    _netKeys:{},
  };
}

function startGame(){
  if(!loadouts[0])return;
  const lv=LEVELS[currentLevel];
  pillars=buildPillarsForLayout(lv.pillarsLayout);
  // Solo: only P1. Co-op: P1 + P2
  if(gameMode==='solo'){
    players=[makePlayer(0,loadouts[0])];
  }else{
    players=[makePlayer(0,loadouts[0]),makePlayer(1,loadouts[1])];
  }
  gamePhase=0;phaseCD=0;enemies=[];projs=[];parts=[];floats=[];fieldFx=[];
  shakeX=shakeY=shakeT=shakeA=0;ann={text:'',t:0,max:0};
  levelTimer=0;killCount=0;lastBossHp=9999;p2autoT=0;
  // Spawn guardians spread across top half
  const bd=BOSS_DEFS[lv.boss];
  const gCount=lv.guardians.length;
  lv.guardians.forEach((el,i)=>{
    const t=(gCount===1)?0.5:(i/(gCount-1));
    const gx=PAD+80+(GW-PAD*2-160)*t;
    const gy=GH*0.25+Math.sin(i*1.3)*60;
    spawnGuardian(el,gx,gy);
  });
  showAnn(`${bd.emoji} ${lv.name.toUpperCase()} â€” BESIEGE DIE WÃ„CHTER!`,4);
  showScreen('game');
  cv=document.getElementById('cv');cv.width=GW;cv.height=GH;ctx=cv.getContext('2d');
  addListeners();running=true;lastT=performance.now();animId=requestAnimationFrame(loop);
}

function spawnGuardian(el,gx,gy){
  enemies.push({id:'g'+Date.now(),type:'guardian',element:el,
    x:clamp(gx,PAD+38,GW-PAD-38),y:clamp(gy,PAD+38,GH-PAD-38),
    r:30,hp:420,maxHp:420,spd:66,atkT:2.6,angle:0,hitFlash:0,
    _wseed:Math.random()*100,
    stunT:0,slowT:0,slowF:1,blindT:0,fearT:0,frozenT:0,
    burnT:0,burnD:0,burnTick:0,poisonT:0,poisonTick:0,_curseDR:0,_curseDur:0,
  });
}

function spawnBoss(){
  const lv=LEVELS[currentLevel];
  const bd=BOSS_DEFS[lv.boss];
  const boss={
    id:'boss',type:'boss',element:bd.boss_el,
    x:GW/2,y:165,r:bd.r,hp:bd.hp,maxHp:bd.hp,phase:0,
    spd:bd.phases[0].spd,atkT:2.2,angle:0,hitFlash:0,
    stunT:0,slowT:0,slowF:1,blindT:0,fearT:0,frozenT:0,
    burnT:0,burnD:0,burnTick:0,poisonT:0,poisonTick:0,_curseDR:0,_curseDur:0,
    // Attack system
    specialCD:8,specialIdx:0,
    chargeCD:bd.phases[0].chargeCD,charging:false,chargeDx:0,chargeDy:0,chargeRemain:0,
    minionCD:15,minionSpawnCount:0,
    phase3T:5,orbRingCD:5,_wseed:Math.random()*100,
    mSpawns:[...bd.phases.map((_,i)=>bd.hp*(1-(i/bd.phases.length))).slice(1)],
    bossEl:bd.boss_el,bossData:bd,
  };
  enemies.push(boss);
}

function spawnMinion(x,y,el){
  const lv=LEVELS[currentLevel];
  const bd=BOSS_DEFS[lv.boss];
  const ph=bd.phases[getBossPhase()];
  enemies.push({
    id:'m'+Date.now()+Math.random(),type:'minion',
    element:el||ph?.minionEl||lv.boss,
    x:clamp(x,PAD+22,GW-PAD-22),y:clamp(y,PAD+22,GH-PAD-22),
    r:18,hp:ph?.minionHP||75,maxHp:ph?.minionHP||75,
    spd:148,atkT:1.6,angle:0,hitFlash:0,_wseed:Math.random()*100,
    stunT:0,slowT:0,slowF:1,blindT:0,fearT:0,frozenT:0,
    burnT:0,burnD:0,burnTick:0,poisonT:0,poisonTick:0,_curseDR:0,_curseDur:0,
  });
}

function getBossPhase(){
  const b=enemies.find(e=>e.type==='boss');if(!b)return 0;
  const bd=b.bossData;
  if(b.hp>bd.hp*0.67)return 0;
  if(b.hp>bd.hp*0.33)return 1;
  return 2;
}

// â”€â”€â”€ INPUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addListeners(){
  document.addEventListener('keydown',onKD);document.addEventListener('keyup',onKU);
  cv.addEventListener('mousemove',onMM);cv.addEventListener('mousedown',onMD);cv.addEventListener('mouseup',onMU);
  cv.addEventListener('contextmenu',e=>e.preventDefault());
  cv.addEventListener('mousemove',checkTip);cv.addEventListener('mouseleave',()=>hideTip());
}
function removeListeners(){
  document.removeEventListener('keydown',onKD);document.removeEventListener('keyup',onKU);
}
function onKD(e){
  keys[e.key]=true;keys[e.key.toLowerCase()]=true;
  const k=e.key.toLowerCase();
  if([' ','arrowup','arrowdown','arrowleft','arrowright'].includes(k))e.preventDefault();
  if(k==='tab'){e.preventDefault();switchEl(0);}
  if(k==='q')useSlot(0,'q');if(k==='e')useSlot(0,'e');
  if(k==='r'&&!e.shiftKey)useFusion(0);
  if(e.key===' ')doDash(0);
  // P2 local
  if(k==='p')switchEl(1);if(k==='1')useSlot(1,'q');if(k==='2')useSlot(1,'e');
  if(k==='3')useFusion(1);if(e.key==='R'&&e.shiftKey)doDash(1);
}
function onKU(e){keys[e.key]=false;keys[e.key.toLowerCase()]=false;if(e.button===2)releaseCharge(0);}
function onMM(e){const r=cv.getBoundingClientRect();mx=e.clientX-r.left;my=e.clientY-r.top;}
function onMD(e){if(e.button===0)useLMB(0);if(e.button===2){players[0].chargeHeld=true;players[0].chargeT=0;}}
function onMU(e){if(e.button===2)releaseCharge(0);}
function switchEl(p){const lo=loadouts[p];if(!lo)return;lo.activeEl=lo.activeEl==='A'?'B':'A';emitP(players[p].x,players[p].y,EL[lo.activeEl==='A'?lo.elemA:lo.elemB].c,8,60);}
function curEl(p){const lo=loadouts[p];return lo?.activeEl==='A'?lo.elemA:lo.elemB;}
function cdM(p){return loadouts[p]?.passive?.cdReduce?1-loadouts[p].passive.cdReduce:1;}
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function pillHit(x,y,r){for(const p of pillars){const ex=clamp(x,p.x,p.x+p.w),ey=clamp(y,p.y,p.y+p.h);if(Math.sqrt((x-ex)**2+(y-ey)**2)<r)return true;}return false;}
function nearE(x,y){return enemies.filter(e=>e.hp>0).sort((a,b)=>(a.x-x)**2+(a.y-y)**2-(b.x-x)**2-(b.y-y)**2)[0]||null;}
function aV(p){
  if(p===0){const pl=players[0],dx=mx-pl.x,dy=my-pl.y,l=Math.sqrt(dx*dx+dy*dy)||1;return{nx:dx/l,ny:dy/l};}
  const pl=players[1];if(!pl)return{nx:0,ny:-1};
  const t=nearE(pl.x,pl.y);
  if(!t)return{nx:0,ny:-1};const dx=t.x-pl.x,dy=t.y-pl.y,l=Math.sqrt(dx*dx+dy*dy)||1;return{nx:dx/l,ny:dy/l};
}
function useLMB(p){
  if(!running||!players[p]?.alive)return;
  const lo=loadouts[p],pl=players[p];
  const sk=lo.activeEl==='A'?lo.lmbA:lo.lmbB;
  if(!sk||pl.cds.lmb>0)return;
  pl.cds.lmb=sk.cd*cdM(p);castSk(p,sk,curEl(p));
}
function releaseCharge(p){
  const pl=players[p];if(!pl?.chargeHeld||!running||!pl.alive){if(pl)pl.chargeHeld=false;return;}
  pl.chargeHeld=false;const lo=loadouts[p];
  const sk=lo.activeEl==='A'?lo.rmbA:lo.rmbB;
  if(!sk||pl.cds.rmb>0)return;
  const cf=Math.min(1,pl.chargeT/1.5);if(cf<.15)return;
  pl.cds.rmb=sk.cd*cdM(p);castSk(p,{...sk,dmg:(sk.dmg||20)*cf},curEl(p));
  doShake(4*cf,.14);pl.chargeT=0;
}
function useSlot(p,s){
  if(!running||!players[p]?.alive)return;
  const lo=loadouts[p],pl=players[p];
  const sk=s==='q'?lo.qSkill:lo.eSkill,el=s==='q'?lo.elemA:lo.elemB;
  if(!sk||pl.cds[s]>0)return;pl.cds[s]=sk.cd*cdM(p);castSk(p,sk,el);
}
function useFusion(p){
  if(!running||!players[p]?.alive)return;
  const lo=loadouts[p],pl=players[p],f=lo.fusion;
  if(!f||pl.cds.r>0)return;
  pl.cds.r=f.cd*(1-(pl.fusionCDR||0));castFusion(p);
}
function doDash(p){
  if(!running||!players[p]?.alive)return;const pl=players[p];if(pl.cds.dash>0)return;
  pl.cds.dash=2.6*(pl.dashCDMult||1);
  let dx=0,dy=0;
  if(p===0){if(keys['a']||keys['ArrowLeft'])dx-=1;if(keys['d']||keys['ArrowRight'])dx+=1;if(keys['w']||keys['ArrowUp'])dy-=1;if(keys['s']||keys['ArrowDown'])dy+=1;}
  else{if(keys['j'])dx-=1;if(keys['l'])dx+=1;if(keys['i'])dy-=1;if(keys['k'])dy+=1;}
  if(!dx&&!dy){const v=aV(p);dx=v.nx;dy=v.ny;}
  const dl=Math.sqrt(dx*dx+dy*dy)||1,ox=pl.x,oy=pl.y;
  pl.x=clamp(pl.x+(dx/dl)*168,PAD+pl.r,GW-PAD-pl.r);pl.y=clamp(pl.y+(dy/dl)*168,PAD+pl.r,GH-PAD-pl.r);
  pl.iframes=.4;if(loadouts[p]?.passive?.pid==='nacht'){pl.stealthOn=true;pl.iframes=.9;}
  emitP(ox,oy,EL[loadouts[p].elemA].c,12,88,dx/dl,dy/dl);
}

// â”€â”€â”€ CAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function gM(p){
  const pl=players[p];let m=pl.critBuff||1;
  if(pl.stealthCrit){m=2.5;pl.stealthCrit=false;pl.stealthOn=false;pl.critBuff=1;}
  if(loadouts[p]?.passive?.pid==='statik'&&pl.staticT>=1){m=Math.max(m,1.4);pl.staticT=0;}
  pl.critBuff=1;return m;
}
function castSk(p,sk,el){
  const pl=players[p],{nx,ny}=aV(p),E=EL[el],mult=gM(p);
  const tx=p===0?mx:nearE(pl.x,pl.y)?.x||pl.x,ty=p===0?my:nearE(pl.x,pl.y)?.y||pl.y;
  switch(sk.t){
   case'proj':default:
    spP({x:pl.x,y:pl.y,vx:nx*(sk.speed||485),vy:ny*(sk.speed||485),r:sk.r||9,color:E.c,glow:E.g,dmg:(sk.dmg||20)*mult,team:'p',srcP:p,el,pierce:sk.pierce,bounce:!!sk.bounce,burn:sk.burn,poison:sk.poison,slow:sk.slow,stun:sk.stun,healHit:sk.healHit,homing:sk.homing,throughWalls:sk.throughWalls,aoe:sk.aoe});emitP(pl.x,pl.y,E.c,6,62,nx,ny);break;
   case'multi':
    for(let i=0;i<(sk.cnt||3);i++){const a=Math.atan2(ny,nx)+(i-(sk.cnt-1)/2)*(sk.spr||.4)/Math.max(1,sk.cnt-1);spP({x:pl.x,y:pl.y,vx:Math.cos(a)*(sk.speed||435),vy:Math.sin(a)*(sk.speed||435),r:sk.r||7,color:E.c,glow:E.g,dmg:(sk.dmg||13)*mult,team:'p',srcP:p,el,burn:sk.burn,poison:sk.poison});}emitP(pl.x,pl.y,E.c,9,70,nx,ny);break;
   case'beam':case'hitscan':{const rng=sk.range||245,cn=sk.cA||.45;enemies.forEach(e=>{if(e.hp<=0)return;const dx=e.x-pl.x,dy=e.y-pl.y,dist=Math.sqrt(dx*dx+dy*dy)||1;if(dist<rng&&Math.acos(Math.min(1,(dx/dist*nx+dy/dist*ny)))<cn)hitE(e,(sk.dmg||17)*mult,el,p,sk.burn,sk.poison,sk.slow,sk.kb,sk.stun,sk.healHit);});emitP(pl.x+nx*rng*.5,pl.y+ny*rng*.5,E.c,12,58,nx,ny);break;}
   case'aoe':doAoe(tx,ty,sk.r||80,(sk.dmg||58)*mult,el,p,sk.stun,sk.burn,sk.kb,sk.fear,sk.blind);emitP(tx,ty,E.c,16,105);break;
   case'daoe':fieldFx.push({type:'meter',x:tx,y:ty,t:sk.delay||1,r:sk.r||80,dmg:(sk.dmg||80)*mult,el,stun:sk.stun,burn:sk.burn,blind:sk.blind,srcP:p});emitP(tx,ty,E.c,8,42);break;
   case'zone':fieldFx.push({type:'zone',x:tx,y:ty,t:sk.life||5,r:sk.r||80,el,dmg:sk.dmgTick||0,healTick:sk.healTick||0,slow:sk.slow,burn:sk.burn,poison:sk.poison,healZ:sk.healZ,tick:0,srcP:p,followP:false});emitP(pl.x,pl.y,E.c,10,65);break;
   case'wall':
    if(sk.windWall)fieldFx.push({type:'windwall',x:tx-6,y:ty-50,w:12,h:100,t:sk.life||5});
    else pillars.push({x:tx-(sk.ww||10)/2,y:ty-(sk.wh||100)/2,w:sk.ww||10,h:sk.wh||100,hp:sk.hp||200,maxHp:sk.hp||200,el,life:sk.life||6,temp:true});
    emitP(pl.x,pl.y,E.c,10,65);break;
   case'dashSkill':{const ox=pl.x,oy=pl.y;pl.x=clamp(pl.x+nx*(sk.range||185),PAD+pl.r,GW-PAD-pl.r);pl.y=clamp(pl.y+ny*(sk.range||185),PAD+pl.r,GH-PAD-pl.r);pl.iframes=.38;enemies.forEach(e=>{if(e.hp<=0)return;if(Math.sqrt((e.x-ox)**2+(e.y-oy)**2)<(sk.range||185)+e.r)hitE(e,(sk.dmg||28)*mult,el,p,sk.burn,null,null,sk.kb);});emitP(ox,oy,E.c,12,85,nx,ny);break;}
   case'buff':
    if(sk.shield)pl.shield=Math.min(pl.shield+(sk.shield||80)*(pl.healBonus||1),300);
    if(sk.reflectDur)pl.reflectT=sk.reflectDur;if(sk.cleanse){pl.burnT=0;pl.poisonT=0;}
    if(sk.speedBuff)pl.speedBuffT=sk.speedBuff;if(sk.stealth){pl.stealthOn=true;pl.stealthCrit=true;}
    if(sk.critMult)pl.critBuff=sk.critMult;
    spawnFT(pl.x,pl.y-28,sk.shield?'+'+Math.round(sk.shield*(pl.healBonus||1))+' ğŸ›¡':sk.cleanse?'GEREINIGT':'AKTIV',E.c);emitP(pl.x,pl.y,E.c,11,85);break;
   case'hook':{const t=nearE(pl.x,pl.y);if(t){const ddx=t.x-pl.x,ddy=t.y-pl.y,dl=Math.sqrt(ddx*ddx+ddy*ddy)||1;pl.x=clamp(t.x-ddx/dl*55,PAD+pl.r,GW-PAD-pl.r);pl.y=clamp(t.y-ddy/dl*55,PAD+pl.r,GH-PAD-pl.r);pl.iframes=.3;hitE(t,(sk.dmg||32)*mult,el,p,null,null,null,null,sk.root);}emitP(pl.x,pl.y,E.c,12,85);break;}
   case'special':
    if(sk.swap){const t=nearE(pl.x,pl.y);if(t){const ox=pl.x,oy=pl.y;pl.x=t.x;pl.y=t.y;t.x=ox;t.y=oy;pl.iframes=.5;hitE(t,(sk.dmg||20)*mult,el,p);}}
    if(sk.rootT){const t=nearE(pl.x,pl.y);if(t){t.stunT=Math.max(t.stunT,sk.rootT);spawnFT(t.x,t.y-28,'ROOT '+sk.rootT+'s',E.c);}}
    if(sk.teleportBehind){const t=nearE(pl.x,pl.y);if(t){pl.x=clamp(t.x+44,PAD+pl.r,GW-PAD-pl.r);pl.y=clamp(t.y+44,PAD+pl.r,GH-PAD-pl.r);pl.iframes=.5;pl.critBuff=sk.critBuff||2;pl.stealthCrit=true;}}
    if(sk.blink){pl.x=clamp(tx,PAD+pl.r,GW-PAD-pl.r);pl.y=clamp(ty,PAD+pl.r,GH-PAD-pl.r);pl.iframes=.4;}
    if(sk.curseE){const t=nearE(pl.x,pl.y);if(t){t._curseDR=sk.curseE.dr||.5;t._curseDur=sk.curseE.dur||6;spawnFT(t.x,t.y-28,'FLUCH -'+Math.round((sk.curseE.dr||.5)*100)+'%',E.c);}}
    emitP(pl.x,pl.y,E.c,9,75);break;
  }
}

// â”€â”€â”€ FUSION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function castFusion(p){
  const f=loadouts[p]?.fusion;if(!f)return;
  const pl=players[p],{nx,ny}=aV(p),E=EL[f.el];
  doShake(14,.55);showAnn(f.e+' '+f.n.toUpperCase(),3);emitP(pl.x,pl.y,E.c,24,145,nx,ny);
  spP({x:pl.x,y:pl.y,vx:nx*190,vy:ny*190,r:24,color:E.c,glow:E.g,dmg:85+Math.random()*30,team:'p',srcP:p,el:f.el,life:5,isFusion:true,fusionFx:f.fx,pierce:false});
  const t=nearE(pl.x,pl.y);
  switch(f.fx){
   case'holyWater':pl.invul=3;pl.hp=Math.min(pl.maxHp,pl.hp+50*(pl.healBonus||1));spawnFT(pl.x,pl.y-28,'INVUL 3s','#fde68a');break;
   case'diamondSkin':pl.invul=5;spawnFT(pl.x,pl.y-28,'DIAMANT 5s','#d4d8a0');break;
   case'lightSpeed':enemies.forEach(e=>{if(e.hp>0){e.slowT=4;e.slowF=.2;}});break;
   case'pollenSleep':enemies.forEach(e=>{if(e.hp>0){e.stunT=Math.max(e.stunT,3);}});break;
   case'eclipse':enemies.forEach(e=>{if(e.hp>0)hitE(e,220,f.el,p,null,null,null,null,null,null,true)});doShake(26,1);emitP(GW/2,GH/2,'#a855f7',50,220);break;
   case'sandstorm':enemies.forEach(e=>{if(e.hp>0)e.blindT=Math.max(e.blindT||0,5);});break;
   case'moonClear':pl.invul=4;enemies.forEach(e=>{if(e.hp>0)e.stunT=Math.max(e.stunT,4);});fieldFx.push({type:'zone',x:GW/2,y:GH/2,t:4,r:GW,el:'light',dmg:0,tick:0,healZ:{a:16,iv:1},srcP:p});break;
   case'shadowStep':for(let i=0;i<5;i++)setTimeout(()=>{if(!running)return;const t2=nearE(pl.x,pl.y);if(t2){hitE(t2,40,f.el,p);emitP(t2.x,t2.y,'#a855f7',6,78);}},i*150);break;
   case'worldTree':pillars.push({x:pl.x-22,y:pl.y-110,w:44,h:220,hp:600,maxHp:600,el:'nature',temp:true,life:9});fieldFx.push({type:'zone',x:pl.x,y:pl.y,t:8,r:85,el:'nature',dmg:0,tick:0,healZ:{a:14,iv:1},srcP:p});break;
   case'lifeSwamp':fieldFx.push({type:'zone',x:pl.x,y:pl.y,t:6,r:100,el:'nature',dmg:8,tick:0,slow:{f:.5},healZ:{a:12,iv:1},srcP:p,followP:p});break;
   case'blizzard':enemies.forEach(e=>{if(e.hp>0){e.frozenT=3;e.stunT=Math.max(e.stunT,3);}});doShake(18,.7);break;
  }
}
function onFusionHit(orb,e){
  const E=EL[orb.el];doAoe(orb.x,orb.y,100,orb.dmg,orb.el,orb.srcP);doShake(12,.45);emitP(orb.x,orb.y,E.c,28,155);
  switch(orb.fusionFx){
   case'steamRoll':doAoe(orb.x,orb.y,140,80,'fire',orb.srcP,1.5,{d:12,dur:3},null,null,3);break;
   case'volcano':fieldFx.push({type:'zone',x:orb.x,y:orb.y,t:8,r:90,el:'fire',dmg:16,tick:0,burn:{d:14,dur:3},srcP:orb.srcP});break;
   case'fireTornado':fieldFx.push({type:'tornado',x:orb.x,y:orb.y,t:5,r:95,el:'fire',dmg:14,vx:orb.vx*.18,vy:orb.vy*.18,angle:0,tick:0,srcP:orb.srcP});break;
   case'fireVines':e.stunT=Math.max(e.stunT,5);applyBurn(e,20,5);break;
   case'supernova':e.blindT=Math.max(e.blindT||0,4);doShake(20,.8);break;
   case'blackFlame':hitE(e,200,'darkness',orb.srcP,null,null,null,null,null,null,true);break;
   case'mudslide':e.stunT=Math.max(e.stunT,3);e.slowT=8;e.slowF=.3;break;
   case'kraken':hitE(e,180,'darkness',orb.srcP,null,null,null,null,2);break;
   case'zombieHands':e.stunT=Math.max(e.stunT,4);hitE(e,120,'darkness',orb.srcP);break;
   case'plague':e.poisonT=8;e.poisonTick=0;applyBurn(e,12,8);break;
  }
}

// â”€â”€â”€ COMBAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doAoe(x,y,r,dmg,el,p,stun,burn,kb,fear,blind,td=false){
  enemies.forEach(e=>{if(e.hp<=0)return;if(Math.sqrt((e.x-x)**2+(e.y-y)**2)<r+e.r){hitE(e,dmg,el,p,burn,null,null,kb,stun,null,td);if(fear)e.fearT=Math.max(e.fearT||0,fear);if(blind&&'blindT'in e)e.blindT=Math.max(e.blindT||0,blind);}});
}
function hitE(e,rawDmg,atkEl,srcP,burn,poison,slow,kb,stun,healHit,trueDmg=false){
  if(e.hp<=0)return;let fd=trueDmg?rawDmg:rawDmg*getEff(atkEl,e.element);
  if(e._curseDur>0)fd*=(1+e._curseDR);
  if(srcP!==null&&srcP!==undefined&&loadouts[srcP]?.passive?.pid==='exek'&&e.hp/e.maxHp<.15)fd*=1.8;
  e.hp-=fd;e.hitFlash=.12;doShake(3,.1);
  const ef=trueDmg?1:getEff(atkEl,e.element);
  if(ef>=2)spawnFT(e.x,e.y-18,'CRIT! '+Math.round(fd),'#ff4444','bold 15px Rajdhani');
  else if(ef<=.5)spawnFT(e.x,e.y-18,'Schwach '+Math.round(fd),'#666','11px Rajdhani');
  else spawnFT(e.x,e.y-18,Math.round(fd).toString(),'#f4c542');
  emitP(e.x,e.y,EL[atkEl]?.c||'#fff',8,68);
  if(burn)applyBurn(e,burn.d,burn.dur||3);
  if(poison){e.poisonT=Math.max(e.poisonT||0,poison.dur||4);e.poisonTick=0;}
  if(slow){e.slowT=Math.max(e.slowT||0,slow.dur||2);e.slowF=Math.min(e.slowF||1,1-(slow.f||.3)+.001);}
  if(stun)e.stunT=Math.max(e.stunT||0,stun);
  if(kb&&srcP!==null){const pl=players[srcP];const bl=Math.sqrt((e.x-pl.x)**2+(e.y-pl.y)**2)||1;e.x=clamp(e.x+(e.x-pl.x)/bl*(kb||0)*.012,PAD+e.r,GW-PAD-e.r);e.y=clamp(e.y+(e.y-pl.y)/bl*(kb||0)*.012,PAD+e.r,GH-PAD-e.r);}
  if(healHit&&srcP!==null){const pl=players[srcP];const h=healHit*(pl.healBonus||1);pl.hp=Math.min(pl.maxHp,pl.hp+h);spawnFT(pl.x,pl.y-22,'+'+Math.round(h),'#4ade80');}
  if(srcP!==null&&players[srcP]?.lifesteal){const pl=players[srcP];pl.hp=Math.min(pl.maxHp,pl.hp+rawDmg*pl.lifesteal);}
  if(e.hp<=0){killCount++;onEDeath(e);}
}
function applyBurn(e,d,t){e.burnD=Math.max(e.burnD||0,d);e.burnT=Math.max(e.burnT||0,t);e.burnTick=Math.min(e.burnTick||.5,.5);}
function hitPl(pl,rawDmg){
  if(pl.iframes>0||pl.invul>0)return;
  if(pl.dodge>0&&Math.random()<pl.dodge){emitP(pl.x,pl.y,'#4fc3f7',5,48);return;}
  if(pl.reflectT>0){pl.reflectT=0;emitP(pl.x,pl.y,'#90caf9',8,58);return;}
  let dmg=rawDmg*(1-(pl.dmgReduce||0));
  if(pl.shield>0){pl.shield=Math.max(0,pl.shield-dmg);emitP(pl.x,pl.y,'#42a5f5',5,50);return;}
  if(pl.thorns){const t=nearE(pl.x,pl.y);if(t)hitE(t,pl.thorns,'earth',null);}
  pl.hp-=dmg;pl.iframes=.5;doShake(7,.22);spawnFT(pl.x,pl.y-22,'-'+Math.round(dmg),'#f87171');
  if(pl.hp<=0){pl.hp=0;pl.alive=false;}
}
function onEDeath(e){
  emitP(e.x,e.y,EL[e.element].c,30+e.r,165);doShake(12,.55);
  if(e.type==='guardian')spawnFT(e.x,e.y-20,'WÃ„CHTER BESIEGT','#f4c542');
  if(e.type==='minion')spawnFT(e.x,e.y-14,'x','#888');
}

// â”€â”€â”€ MAIN LOOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loop(ts){if(!running)return;const dt=Math.min((ts-lastT)/1000,.05);lastT=ts;update(dt);render();animId=requestAnimationFrame(loop);}

function update(dt){
  levelTimer+=dt;
  updMove(0,dt);updMove(1,dt);
  // P2 AI auto-attack
  if(loadouts[1]?.ai){
    p2autoT-=dt;
    if(players[1]?.alive&&p2autoT<=0){
      const lo=loadouts[1],pl=players[1];
      const sk=lo.activeEl==='A'?lo.lmbA:lo.lmbB;
      if(pl.cds.lmb<=0&&sk){useLMB(1);p2autoT=sk.cd*cdM(1);}else p2autoT=.28;
      if(pl.cds.q<=0&&Math.random()<.025)useSlot(1,'q');
      if(pl.cds.e<=0&&Math.random()<.02)useSlot(1,'e');
      if(pl.cds.r<=0&&loadouts[1].fusion&&Math.random()<.006)useFusion(1);
    }
    // P2 IJKL
    if(keys['o']&&players[1]?.alive){players[1].chargeHeld=true;players[1].chargeT=(players[1].chargeT||0)+dt;}
    if(!keys['o']&&players[1]?.chargeHeld)releaseCharge(1);
  }
  players.forEach(pl=>{if(!pl.alive)return;for(const k of['lmb','rmb','q','e','r','dash'])if(pl.cds[k]>0)pl.cds[k]=Math.max(0,pl.cds[k]-dt);if(pl.chargeHeld)pl.chargeT+=dt;});
  enemies.forEach(e=>{if(e.hp>0)updEnemy(e,dt);});
  updProjs(dt);updFieldFx(dt);updPillars(dt);updParts(dt);
  if(shakeT>0){shakeT-=dt;shakeX=(Math.random()-.5)*shakeA;shakeY=(Math.random()-.5)*shakeA;}else{shakeX=shakeY=0;}
  if(ann.t>0)ann.t-=dt;
  for(let i=floats.length-1;i>=0;i--){floats[i].y-=44*dt;floats[i].t-=dt;if(floats[i].t<=0)floats.splice(i,1);}
  updPhase(dt);
  if(gamePhase===2&&enemies.filter(e=>e.hp>0).length===0)endLevel();
  if(players.every(p=>!p.alive))endGame(false);
}

function updPhase(dt){
  if(gamePhase===0){
    if(enemies.filter(e=>e.type==='guardian').every(e=>e.hp<=0)&&enemies.filter(e=>e.type==='guardian').length>0){
      gamePhase=1;phaseCD=3;
      const lv=LEVELS[currentLevel];const bd=BOSS_DEFS[lv.boss];
      showAnn(`${bd.emoji} ${bd.name.toUpperCase()} IN 3s!`,4);
    }
  }else if(gamePhase===1){phaseCD-=dt;if(phaseCD<=0){gamePhase=2;spawnBoss();const bd=BOSS_DEFS[LEVELS[currentLevel].boss];showAnn(`ğŸ’¥ BOSS: ${bd.name} â€” ${bd.desc}`,4);}}
}

function updMove(p,dt){
  const pl=players[p];if(!pl?.alive)return;
  let dx=0,dy=0;
  if(p===0){if(keys['a']||keys['ArrowLeft'])dx-=1;if(keys['d']||keys['ArrowRight'])dx+=1;if(keys['w']||keys['ArrowUp'])dy-=1;if(keys['s']||keys['ArrowDown'])dy+=1;}
  else if(!loadouts[1]?.ai){if(keys['j'])dx-=1;if(keys['l'])dx+=1;if(keys['i'])dy-=1;if(keys['k'])dy+=1;}
  else{
    // AI move toward nearest enemy
    const t=nearE(pl.x,pl.y);if(t){const ddx=t.x-pl.x,ddy=t.y-pl.y,dl=Math.sqrt(ddx*ddx+ddy*ddy)||1;if(dl>80){dx=ddx/dl;dy=ddy/dl;}else if(dl<40){dx=-ddx/dl*0.5;dy=-ddy/dl*0.5;}}
  }
  if(dx&&dy){dx*=.707;dy*=.707;}
  const mov=!!(dx||dy);
  if(mov)pl.staticT=Math.min((pl.staticT||0)+dt,1);else pl.staticT=Math.max(0,(pl.staticT||0)-dt*.5);
  let spd=pl.spd*(pl.speedBuffT>0?1.5:1);if(pl.speedBuffT>0)pl.speedBuffT-=dt;
  const nx=pl.x+dx*spd*dt,ny=pl.y+dy*spd*dt;
  if(!pillHit(nx,ny,pl.r)){pl.x=clamp(nx,PAD+pl.r,GW-PAD-pl.r);pl.y=clamp(ny,PAD+pl.r,GH-PAD-pl.r);}
  else{const nx2=pl.x+dx*spd*dt;if(!pillHit(nx2,pl.y,pl.r))pl.x=clamp(nx2,PAD+pl.r,GW-PAD-pl.r);const ny2=pl.y+dy*spd*dt;if(!pillHit(pl.x,ny2,pl.r))pl.y=clamp(ny2,PAD+pl.r,GH-PAD-pl.r);}
  if(pl.iframes>0)pl.iframes-=dt;if(pl.invul>0)pl.invul-=dt;if(pl.reflectT>0)pl.reflectT-=dt;
  if(pl.photoRegen&&!mov)pl.hp=Math.min(pl.maxHp,pl.hp+pl.photoRegen*dt);
  if(pl.hpRegen)pl.hp=Math.min(pl.maxHp,pl.hp+pl.hpRegen*dt);
  if(pl.burnT>0){pl.burnT-=dt;pl.burnTick-=dt;if(pl.burnTick<=0){pl.hp-=pl.burnD||0;pl.burnTick=.5;emitP(pl.x,pl.y-8,'#ff6b1a',3,28);}}
  if(pl.poisonT>0){pl.poisonT-=dt;pl.poisonTick-=dt;if(pl.poisonTick<=0){pl.hp-=5;pl.poisonTick=.4;emitP(pl.x,pl.y-8,'#4ade80',2,24);}}
  pl.hp=Math.min(pl.maxHp,pl.hp);if(pl.hp<=0&&pl.alive){pl.hp=0;pl.alive=false;}
  players.forEach(pl2=>{if(!pl2.alive||pl2.iframes>0)return;const dx2=pl.x-pl2.x,dy2=pl.y-pl2.y;if(Math.sqrt(dx2*dx2+dy2*dy2)<pl.r+pl2.r&&p!==pl2.id){/* player-player overlap: push apart */}});
}

function updEnemy(e,dt){
  if(e.frozenT>0){e.frozenT-=dt;return;}
  if(e.stunT>0){e.stunT-=dt;return;}
  const alive=players.filter(p=>p.alive);if(!alive.length)return;
  // Target nearest player
  let tgt=alive.sort((a,b)=>(a.x-e.x)**2+(a.y-e.y)**2-(b.x-e.x)**2-(b.y-e.y)**2)[0];
  const isFear=(e.fearT||0)>0;if(isFear)e.fearT-=dt;
  // Speed from type/phase
  const phIdx=e.type==='boss'?getBossPhase():0;
  const bd=e.bossData;
  let spd=e.type==='boss'?(bd?.phases[phIdx]?.spd||e.spd):e.type==='minion'?148:e.spd;
  spd*=(e.slowT>0?e.slowF:1);
  if((e.blindT||0)>0){e.blindT-=dt;spd*=.4;}
  // â”€â”€â”€ BOSS CHARGE â”€â”€â”€
  if(e.type==='boss'){
    e.chargeCD-=dt;
    if(!e.charging&&e.chargeCD<=0&&phIdx>=1){
      e.charging=true;const dl=Math.sqrt((tgt.x-e.x)**2+(tgt.y-e.y)**2)||1;
      e.chargeDx=(tgt.x-e.x)/dl;e.chargeDy=(tgt.y-e.y)/dl;
      e.chargeRemain=.52;e.chargeCD=(bd?.phases[phIdx]?.chargeCD||7);
      emitP(e.x,e.y,EL[e.element].c,15,120,e.chargeDx,e.chargeDy);
      spawnFT(e.x,e.y-62,'âš¡ CHARGE!',EL[e.element].c);
    }
    if(e.charging){
      const cx=e.x+e.chargeDx*520*dt,cy=e.y+e.chargeDy*520*dt;
      if(!pillHit(cx,cy,e.r)){e.x=clamp(cx,PAD+e.r,GW-PAD-e.r);e.y=clamp(cy,PAD+e.r,GH-PAD-e.r);}
      else{e.charging=false;doShake(6,.2);}
      e.chargeRemain-=dt;if(e.chargeRemain<=0){e.charging=false;doShake(8,.3);emitP(e.x,e.y,EL[e.element].c,18,100);}
      // Contact damage during charge
      players.forEach(pl=>{if(!pl.alive||pl.iframes>0)return;if(Math.sqrt((pl.x-e.x)**2+(pl.y-e.y)**2)<pl.r+e.r+4)hitPl(pl,28);});
    }
    // â”€â”€â”€ BOSS SPECIAL ATTACKS â”€â”€â”€
    e.specialCD-=dt;
    if(e.specialCD<=0&&!e.charging){
      e.specialCD=5.5+Math.random()*3;
      const atks=bd?.specialAtks||[];
      const atk=atks[e.specialIdx%atks.length];e.specialIdx++;
      doBossSpecial(e,tgt,atk,phIdx);
    }
    // â”€â”€â”€ PHASE ORB RING (P3) â”€â”€â”€
    if(phIdx===2){e.orbRingCD-=dt;if(e.orbRingCD<=0){e.orbRingCD=4.5;spawnOrbRing(e,tgt);}}
    // â”€â”€â”€ MINION SPAWNS â”€â”€â”€
    if(e.mSpawns&&e.mSpawns.length>0){
      for(let i=e.mSpawns.length-1;i>=0;i--){
        if(e.hp<e.mSpawns[i]){e.mSpawns.splice(i,1);bossSpawnMinions(e,phIdx+2);}
      }
    }
    e.minionCD-=dt;
    if(phIdx===2&&e.minionCD<=0){e.minionCD=14;bossSpawnMinions(e,2);}
    // â”€â”€â”€ PHASE TRANSITIONS â”€â”€â”€
    const prevPhase=e.phase;
    e.phase=phIdx;
    if(phIdx!==prevPhase){
      doShake(24,.95);emitP(e.x,e.y,'#fff',55,230);
      const pNames=['Phase 1','Phase 2 â€” Aggro!','Phase 3 â€” ENRAGE!'];
      showAnn(`ğŸ’€ ${bd?.name||'BOSS'} â€” ${pNames[phIdx]}`,4);
    }
  }
  // â”€â”€â”€ MOVEMENT (with pillar avoidance) â”€â”€â”€
  if(!e.charging){
    let tdx=isFear?(e.x-tgt.x):(tgt.x-e.x),tdy=isFear?(e.y-tgt.y):(tgt.y-e.y);
    const dist=Math.sqrt(tdx*tdx+tdy*tdy)||1;
    let sx=0,sy=0;
    for(const pl of pillars){const cx=pl.x+pl.w/2,cy=pl.y+pl.h/2,dx=e.x-cx,dy=e.y-cy,d=Math.sqrt(dx*dx+dy*dy)||1,minD=e.r+Math.max(pl.w,pl.h)*.6+18;if(d<minD){sx+=dx/d*(minD-d);sy+=dy/d*(minD-d);}}
    // Wander offset to prevent getting stuck
    const wander=e.type==='boss'?0.18:0.06;
    const ws=e._wseed||0;
    const wx=(Math.sin(Date.now()*.0008+ws)*wander);
    const wy=(Math.cos(Date.now()*.0011+ws)*wander);
    const mvx=(tdx/dist)*spd*dt+sx*.22+wx*spd*dt;
    const mvy=(tdy/dist)*spd*dt+sy*.22+wy*spd*dt;
    const nx=e.x+mvx,ny=e.y+mvy;
    if(!pillHit(nx,ny,e.r)){e.x=clamp(nx,PAD+e.r,GW-PAD-e.r);e.y=clamp(ny,PAD+e.r,GH-PAD-e.r);}
    else{const nx2=e.x+mvx;if(!pillHit(nx2,e.y,e.r))e.x=clamp(nx2,PAD+e.r,GW-PAD-e.r);const ny2=e.y+mvy;if(!pillHit(e.x,ny2,e.r))e.y=clamp(ny2,PAD+e.r,GH-PAD-e.r);}
  }
  // â”€â”€â”€ NORMAL ATTACK â”€â”€â”€
  e.atkT-=dt;
  if(e.atkT<=0&&!(e.blindT>0)){
    const phIdx2=e.type==='boss'?getBossPhase():0;
    const bd2=e.bossData;
    e.atkT=e.type==='boss'?(phIdx2===0?2.4:phIdx2===1?1.7:1.1):e.type==='minion'?1.5:2.8;
    eAtk(e,tgt,phIdx2);
  }
  if(e.slowT>0)e.slowT-=dt;
  if(e._curseDur>0)e._curseDur-=dt;else e._curseDR=0;
  if(e.burnT>0){e.burnT-=dt;e.burnTick-=dt;if(e.burnTick<=0){e.hp-=e.burnD||0;e.burnTick=.5;emitP(e.x+(Math.random()-.5)*30,e.y+(Math.random()-.5)*20,'#ff6b1a',2,34);if(e.hp<=0)onEDeath(e);}}
  if(e.poisonT>0){e.poisonT-=dt;e.poisonTick-=dt;if(e.poisonTick<=0){e.hp-=9;e.poisonTick=.35;if(e.hp<=0)onEDeath(e);}}
  if(e.hitFlash>0)e.hitFlash-=dt;
  e.angle+=dt*(e.type==='boss'?getBossPhase()===2?3.2:1.8:e.type==='minion'?4:1.5);
  players.forEach(pl=>{if(!pl.alive||pl.iframes>0)return;if(Math.sqrt((pl.x-e.x)**2+(pl.y-e.y)**2)<pl.r+e.r)hitPl(pl,e.type==='minion'?11:19);});
}

// â”€â”€â”€ BOSS SPECIAL ATTACKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doBossSpecial(e,tgt,atk,phase){
  const el=e.element,E=EL[el];
  if(!atk)return;
  switch(atk){
   // FIRE BOSS
   case'fireBreath':
    for(let i=0;i<8;i++){const a=Math.atan2(tgt.y-e.y,tgt.x-e.x)+(i-3.5)*.22;spP({x:e.x,y:e.y,vx:Math.cos(a)*340,vy:Math.sin(a)*340,r:10,color:'#ff6b1a',glow:'#ff4500',dmg:16,team:'e',el,burn:{d:12,dur:3}});}
    break;
   case'meteors':
    for(let i=0;i<3+phase;i++){const mx2=tgt.x+(Math.random()-.5)*180,my2=tgt.y+(Math.random()-.5)*180;fieldFx.push({type:'meter',x:mx2,y:my2,t:.9,r:55,dmg:55,el,burn:{d:15,dur:3},srcP:null});}
    break;
   case'firePillar':
    fieldFx.push({type:'zone',x:tgt.x,y:tgt.y,t:4,r:50,el,dmg:20,tick:0,burn:{d:12,dur:2},srcP:null});
    break;
   case'flameRing':
    for(let i=0;i<12;i++){const a=(i/12)*Math.PI*2;spP({x:e.x,y:e.y,vx:Math.cos(a)*240,vy:Math.sin(a)*240,r:8,color:'#ff6b1a',glow:'#ff4500',dmg:14,team:'e',el,burn:{d:8,dur:2}});}
    break;
   // WATER BOSS
   case'tidalWave':
    for(let i=0;i<6;i++){const a=Math.atan2(tgt.y-e.y,tgt.x-e.x)+(i-2.5)*.18;spP({x:e.x,y:e.y,vx:Math.cos(a)*310,vy:Math.sin(a)*310,r:16,color:'#42a5f5',glow:'#1e88e5',dmg:22,team:'e',el,slow:{f:.4,dur:2}});}
    break;
   case'waterPrison':
    fieldFx.push({type:'zone',x:tgt.x,y:tgt.y,t:3.5,r:65,el,dmg:14,tick:0,slow:{f:.7},srcP:null});
    break;
   case'healSelf':
    if(e.hp<e.maxHp*.7){e.hp=Math.min(e.maxHp,e.hp+e.maxHp*.08);spawnFT(e.x,e.y-60,'+'+Math.round(e.maxHp*.08)+' HEAL','#42a5f5');}
    break;
   case'vortex':
    players.forEach(pl=>{if(!pl.alive)return;const dx=e.x-pl.x,dy=e.y-pl.y,dl=Math.sqrt(dx*dx+dy*dy)||1;pl.x=clamp(pl.x+dx/dl*90,PAD+pl.r,GW-PAD-pl.r);pl.y=clamp(pl.y+dy/dl*90,PAD+pl.r,GH-PAD-pl.r);hitPl(pl,16);});
    break;
   // EARTH BOSS
   case'groundSlam':
    doAoe(e.x,e.y,140,45,el,null,2,null,120);doShake(16,.6);
    for(let i=0;i<8;i++){const a=(i/8)*Math.PI*2;fieldFx.push({type:'meter',x:e.x+Math.cos(a)*100,y:e.y+Math.sin(a)*100,t:.6,r:30,dmg:35,el,stun:.8,srcP:null});}
    break;
   case'rockSpikes':
    for(let i=0;i<5+phase;i++){const a=Math.atan2(tgt.y-e.y,tgt.x-e.x)+(i-2)*.3;spP({x:e.x,y:e.y,vx:Math.cos(a)*280,vy:Math.sin(a)*280,r:13,color:'#a3a86e',glow:'#8d9234',dmg:28,team:'e',el,stun:.6});}
    break;
   case'stoneWalls':
    for(let i=0;i<2;i++){const angle=Math.random()*Math.PI;pillars.push({x:tgt.x+Math.cos(angle)*30-8,y:tgt.y+Math.sin(angle)*30-50,w:16,h:100,hp:150,maxHp:150,el,temp:true,life:8});}
    break;
   case'quakeShockwave':
    emitP(e.x,e.y,'#a3a86e',40,200);doShake(20,.8);
    players.forEach(pl=>{if(!pl.alive)return;const dx=pl.x-e.x,dy=pl.y-e.y,dl=Math.sqrt(dx*dx+dy*dy)||1;pl.x=clamp(pl.x+dx/dl*160,PAD+pl.r,GW-PAD-pl.r);pl.y=clamp(pl.y+dy/dl*160,PAD+pl.r,GH-PAD-pl.r);hitPl(pl,22);});
    break;
   // WIND BOSS
   case'windBarrage':
    for(let i=0;i<10+phase*3;i++){const a=(i/(10+phase*3))*Math.PI*2;spP({x:e.x,y:e.y,vx:Math.cos(a)*400,vy:Math.sin(a)*400,r:7,color:'#4fc3f7',glow:'#29b6f6',dmg:12,team:'e',el,pierce:true});}
    break;
   case'tornadoSpin':
    fieldFx.push({type:'tornado',x:e.x,y:e.y,t:4,r:85,el,dmg:12,vx:(Math.random()-.5)*60,vy:(Math.random()-.5)*60,angle:0,tick:0,srcP:null});
    break;
   case'vacuum':
    players.forEach(pl=>{if(!pl.alive)return;const dx=e.x-pl.x,dy=e.y-pl.y,dl=Math.sqrt(dx*dx+dy*dy)||1;pl.x=clamp(pl.x+dx/dl*130,PAD+pl.r,GW-PAD-pl.r);pl.y=clamp(pl.y+dy/dl*130,PAD+pl.r,GH-PAD-pl.r);});
    break;
   case'airBurst':
    doAoe(tgt.x,tgt.y,90,35,el,null,null,null,200);fieldFx.push({type:'meter',x:tgt.x,y:tgt.y,t:.5,r:80,dmg:40,el,srcP:null});
    break;
   // NATURE BOSS
   case'rootCage':
    players.forEach(pl=>{if(!pl.alive)return;pl.stunT=(pl.stunT||0)+2.5;spawnFT(pl.x,pl.y-28,'ROOT 2.5s','#4ade80');});
    break;
   case'sporeBurst':
    for(let i=0;i<12;i++){const a=(i/12)*Math.PI*2;spP({x:e.x+Math.cos(a)*e.r,y:e.y+Math.sin(a)*e.r,vx:Math.cos(a)*200,vy:Math.sin(a)*200,r:9,color:'#4ade80',glow:'#16a34a',dmg:14,team:'e',el,poison:{d:8,dur:4}});}
    break;
   case'natureSeal':
    players.forEach(pl=>{if(!pl.alive)return;pl.cds.r=Math.max(pl.cds.r,8);spawnFT(pl.x,pl.y-28,'FUSION GESPERRT 8s','#4ade80');});
    break;
   case'healing':
    e.hp=Math.min(e.maxHp,e.hp+e.maxHp*.06);spawnFT(e.x,e.y-60,'+NATUR-HEILUNG','#4ade80');emitP(e.x,e.y,'#4ade80',20,80);
    break;
   // LIGHT BOSS
   case'solarFlare':
    doAoe(e.x,e.y,180,38,el,null,null,null,null,null,3.5);doShake(12,.5);
    break;
   case'blindPulse':
    players.forEach(pl=>{if(pl.alive){pl.stunT=(pl.stunT||0)+2;spawnFT(pl.x,pl.y-28,'GEBLENDET 2s','#fde68a');}});
    break;
   case'holyBeam':{const a=Math.atan2(tgt.y-e.y,tgt.x-e.x);for(let i=0;i<3;i++)setTimeout(()=>{if(!running)return;spP({x:e.x,y:e.y,vx:Math.cos(a)*600,vy:Math.sin(a)*600,r:12,color:'#fde68a',glow:'#f59e0b',dmg:28,team:'e',el,pierce:true,blind:1.5});},i*180);break;}
   case'reviveMinions':
    const dead=enemies.filter(en=>en.type==='minion'&&en.hp<=0);
    dead.slice(0,2).forEach(m=>{m.hp=m.maxHp*.5;emitP(m.x,m.y,'#fde68a',12,68);});
    if(dead.length===0)bossSpawnMinions(e,1);
    break;
   // DARKNESS BOSS
   case'shadowBeam':{const bx=e.x,by=e.y,a2=Math.atan2(tgt.y-by,tgt.x-bx);for(let i=0;i<4;i++)setTimeout(()=>{if(!running)return;spP({x:bx,y:by,vx:Math.cos(a2+(i-.5)*.12)*520,vy:Math.sin(a2+(i-.5)*.12)*520,r:10,color:'#a855f7',glow:'#7e22ce',dmg:24,team:'e',el,throughWalls:true});},i*80);break;}
   case'fearShout':
    players.forEach(pl=>{if(pl.alive){pl.stunT=(pl.stunT||0)+2.2;spawnFT(pl.x,pl.y-28,'ANGST 2.2s','#a855f7');}});doShake(14,.5);
    break;
   case'voidPortal':
    for(let i=0;i<6;i++){const a=(i/6)*Math.PI*2,ox=GW/2+Math.cos(a)*200,oy=GH/2+Math.sin(a)*180;spP({x:ox,y:oy,vx:(tgt.x-ox)/2.8,vy:(tgt.y-oy)/2.8,r:10,color:'#a855f7',glow:'#7e22ce',dmg:18,team:'e',el,throughWalls:true});}
    break;
   case'lifeSteal':
    players.forEach(pl=>{if(!pl.alive)return;const dmg=Math.min(pl.hp*.14,25);pl.hp-=dmg;if(pl.hp<=0)pl.alive=false;e.hp=Math.min(e.maxHp,e.hp+dmg*2);spawnFT(e.x,e.y-55,'+LIFESTEAL','#a855f7');});
    break;
  }
}

function bossSpawnMinions(boss,count){
  showAnn('âš  VERSTÃ„RKUNG!',2);doShake(16,.6);
  for(let j=0;j<count;j++){const a=(j/count)*Math.PI*2;spawnMinion(boss.x+Math.cos(a)*95,boss.y+Math.sin(a)*95);}
}

// â”€â”€â”€ ENEMY NORMAL ATTACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function eAtk(e,tgt,phIdx){
  const dx=tgt.x-e.x,dy=tgt.y-e.y,l=Math.sqrt(dx*dx+dy*dy)||1;
  const bd=e.bossData;
  const pattern=bd?.phases[phIdx]?.atkPattern||'spread3';
  const col=EL[e.element].c,glow=EL[e.element].g;
  let cnt=1,spr=0,spd2=270,dmg=16,extraBurn=null,extraPoison=null,extraSlow=null;
  if(e.type==='boss'){
    // Parse pattern string
    if(pattern.includes('spread'))cnt=parseInt(pattern.match(/spread(\d+)/)?.[1]||'3');
    if(pattern.includes('fast'))cnt=parseInt(pattern.match(/fast(\d+)/)?.[1]||'5');
    if(pattern.includes('laser'))cnt=parseInt(pattern.match(/laser(\d+)/)?.[1]||'3');
    if(pattern.includes('poison'))cnt=parseInt(pattern.match(/poison(\d+)/)?.[1]||'3');
    if(pattern.includes('shadow'))cnt=parseInt(pattern.match(/shadow(\d+)/)?.[1]||'3');
    if(pattern.includes('homing'))cnt=parseInt(pattern.match(/homing(\d+)/)?.[1]||'3');
    if(pattern.includes('boulder'))cnt=3;
    spr=cnt>1?.28:0;spd2=e.element==='wind'?420:e.element==='light'?480:275;
    dmg=phIdx===0?19:phIdx===1?16:13;
    if(e.element==='fire')extraBurn={d:8,dur:2};
    if(e.element==='nature')extraPoison={d:6,dur:3};
    if(e.element==='water')extraSlow={f:.3,dur:2};
  }else if(e.type==='minion'){cnt=1;spd2=295;dmg=12;}
  for(let i=0;i<cnt;i++){
    const a=Math.atan2(dy,dx)+(cnt>1?(i-(cnt-1)/2)*spr:0);
    spP({x:e.x,y:e.y,vx:Math.cos(a)*spd2,vy:Math.sin(a)*spd2,r:cnt>4?7:9,color:col,glow,dmg,team:'e',el:e.element,burn:extraBurn,poison:extraPoison,slow:extraSlow,homing:pattern.includes('homing')&&i<2});
  }
  // Extra patterns
  if(pattern.includes('fire')&&e.type==='boss'){for(let i=0;i<4;i++){const a2=(i/4)*Math.PI*2;spP({x:e.x,y:e.y,vx:Math.cos(a2)*200,vy:Math.sin(a2)*200,r:8,color:col,glow,dmg:11,team:'e',el:e.element,burn:{d:10,dur:2}});}}
  if(pattern.includes('wave')&&e.type==='boss'){for(let i=0;i<8;i++){const a2=Math.atan2(dy,dx)+(i-3.5)*.2;spP({x:e.x,y:e.y,vx:Math.cos(a2)*320,vy:Math.sin(a2)*320,r:14,color:col,glow,dmg:18,team:'e',el:e.element,slow:{f:.4,dur:2}});}}
  if(pattern.includes('roots')){players.forEach(pl=>{if(!pl.alive)return;if(Math.sqrt((pl.x-e.x)**2+(pl.y-e.y)**2)<200)pl.stunT=Math.max(pl.stunT||0,.8);});}
  if(pattern.includes('meteor')){const mx2=tgt.x+(Math.random()-.5)*120,my2=tgt.y+(Math.random()-.5)*120;fieldFx.push({type:'meter',x:mx2,y:my2,t:1.1,r:50,dmg:55,el:e.element,burn:extraBurn,srcP:null});}
  if(pattern.includes('blind')){players.forEach(pl=>{if(pl.alive&&Math.random()<.35)pl.stunT=Math.max(pl.stunT||0,1.2);});}
  if(pattern.includes('fear')){if(Math.random()<.25)players.forEach(pl=>{if(pl.alive)pl.stunT=Math.max(pl.stunT||0,1.5);});}
  if(pattern.includes('drain')){players.forEach(pl=>{if(!pl.alive)return;const d2=Math.min(8,pl.hp*.06);pl.hp-=d2;e.hp=Math.min(e.maxHp,e.hp+d2*1.5);});}
  if(pattern.includes('curse')){if(Math.random()<.2)players.forEach(pl=>{if(pl.alive){pl.burnT=3;pl.burnD=8;pl.burnTick=.5;spawnFT(pl.x,pl.y-20,'FLUCH','#a855f7');}});}
  if(pattern.includes('portal')){for(let i=0;i<3;i++){const ox=PAD+80+Math.random()*(GW-PAD*2-160),oy=PAD+80+Math.random()*(GH-PAD*2-160);spP({x:ox,y:oy,vx:(tgt.x-ox)/3,vy:(tgt.y-oy)/3,r:9,color:'#a855f7',glow:'#7e22ce',dmg:16,team:'e',el:e.element,throughWalls:true});}}
  if(pattern.includes('ring')&&e.type==='boss'){spawnOrbRing(e,tgt);}
  if(pattern.includes('tidal')){for(let i=0;i<3;i++)setTimeout(()=>{if(!running||e.hp<=0)return;for(let j=0;j<6;j++){const a2=(j/6)*Math.PI*2;spP({x:e.x,y:e.y,vx:Math.cos(a2)*350,vy:Math.sin(a2)*350,r:10,color:'#42a5f5',glow:'#1e88e5',dmg:16,team:'e',el:e.element});}},i*400);}
  if(pattern.includes('fullBlast')){for(let i=0;i<16;i++){const a2=(i/16)*Math.PI*2;spP({x:e.x,y:e.y,vx:Math.cos(a2)*320,vy:Math.sin(a2)*320,r:9,color:'#fde68a',glow:'#f59e0b',dmg:20,team:'e',el:e.element,pierce:true});}}
  if(pattern.includes('heal')){e.hp=Math.min(e.maxHp,e.hp+e.maxHp*.04);}
}

function spawnOrbRing(e,tgt){
  for(let i=0;i<5;i++){const a=(i/5)*Math.PI*2+e.angle;const ox=e.x+Math.cos(a)*115,oy=e.y+Math.sin(a)*115;spP({x:ox,y:oy,vx:(tgt.x-ox)/2.8,vy:(tgt.y-oy)/2.8,r:9,color:EL[e.element].c,glow:EL[e.element].g,dmg:14,team:'e',el:e.element,life:3.5});}
}

// â”€â”€â”€ PROJECTILES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updProjs(dt){
  for(let i=projs.length-1;i>=0;i--){
    const p=projs[i];
    if(p.homing&&p.team==='e'){const t=players.filter(pl=>pl.alive)[0];if(t){const ddx=t.x-p.x,ddy=t.y-p.y,dl=Math.sqrt(ddx*ddx+ddy*ddy)||1;p.vx+=(ddx/dl*3.5-p.vx*.06)*dt*55;p.vy+=(ddy/dl*3.5-p.vy*.06)*dt*55;}}
    if(p.homing&&p.team==='p'){const t=nearE(p.x,p.y);if(t){const ddx=t.x-p.x,ddy=t.y-p.y,dl=Math.sqrt(ddx*ddx+ddy*ddy)||1;p.vx+=(ddx/dl*3-p.vx*.06)*dt*58;p.vy+=(ddy/dl*3-p.vy*.06)*dt*58;}}
    p.x+=p.vx*dt;p.y+=p.vy*dt;p.life-=dt;
    if(p.life<=0||p.x<-80||p.x>GW+80||p.y<-80||p.y>GH+80){projs.splice(i,1);continue;}
    if(!p.throughWalls){
      let blk=false;
      for(const pl2 of pillars){
        if(p.x>pl2.x-p.r&&p.x<pl2.x+pl2.w+p.r&&p.y>pl2.y-p.r&&p.y<pl2.y+pl2.h+p.r){
          if(p.bounce&&!p._bounced){p.vx*=-.85;p.vy*=-.85;p._bounced=true;}
          else{if(pl2.temp&&pl2.hp!==undefined){pl2.hp-=(p.dmg||20);if(pl2.hp<=0){const pi=pillars.indexOf(pl2);if(pi>=0)pillars.splice(pi,1);}}projs.splice(i,1);blk=true;}
          break;
        }
      }
      if(blk)continue;
    }
    if(p.team==='p'){
      let hit=false;
      for(const e of enemies){if(e.hp<=0)continue;if(Math.sqrt((p.x-e.x)**2+(p.y-e.y)**2)<e.r+p.r){
        if(p.isFusion)onFusionHit(p,e);else hitE(e,p.dmg,p.el,p.srcP,p.burn,p.poison,p.slow,null,p.stun,p.healHit);
        if(p.aoe)emitP(p.x,p.y,EL[p.el]?.c||'#fff',11,75);
        if(!p.pierce){projs.splice(i,1);hit=true;break;}
      }}
    }else{
      for(const pl2 of players){if(!pl2.alive||pl2.iframes>0||pl2.invul>0)continue;if(Math.sqrt((p.x-pl2.x)**2+(p.y-pl2.y)**2)<pl2.r+p.r){hitPl(pl2,p.dmg);const idx=projs.indexOf(p);if(idx>=0)projs.splice(idx,1);break;}}
    }
  }
}

function updFieldFx(dt){
  for(let i=fieldFx.length-1;i>=0;i--){
    const ef=fieldFx[i];ef.t-=dt;
    if(typeof ef.followP==='number'&&players[ef.followP]?.alive){ef.x=players[ef.followP].x;ef.y=players[ef.followP].y;}
    if(ef.type==='tornado'){ef.angle+=dt*5.5;ef.x+=(ef.vx||0)*dt;ef.y+=(ef.vy||0)*dt;if(ef.x<PAD+ef.r)ef.vx=Math.abs(ef.vx||0);if(ef.x>GW-PAD-ef.r)ef.vx=-Math.abs(ef.vx||0);if(ef.y<PAD+ef.r)ef.vy=Math.abs(ef.vy||0);if(ef.y>GH-PAD-ef.r)ef.vy=-Math.abs(ef.vy||0);}
    if(ef.type==='meter'){if(ef.t<=0){doAoe(ef.x,ef.y,ef.r,ef.dmg,ef.el,ef.srcP,ef.stun,ef.burn,null,null,ef.blind);emitP(ef.x,ef.y,'#ff4500',28,155);doShake(12,.5);fieldFx.splice(i,1);}continue;}
    if(ef.type==='windwall'){if(ef.t<=0)fieldFx.splice(i,1);continue;}
    ef.tick=(ef.tick||0)-dt;
    if(ef.tick<=0){
      ef.tick=.4;
      if((ef.dmg||0)>0){enemies.forEach(e=>{if(e.hp<=0)return;if(Math.sqrt((e.x-ef.x)**2+(e.y-ef.y)**2)<(ef.r||80)+e.r){hitE(e,ef.dmg,ef.el,ef.srcP??null,ef.burn,ef.poison,ef.slow);if(ef.type==='tornado'){e.x=clamp(e.x+(ef.x-e.x)*.06,PAD+e.r,GW-PAD-e.r);e.y=clamp(e.y+(ef.y-e.y)*.06,PAD+e.r,GH-PAD-e.r);}}});}
      if((ef.healTick||0)>0)players.forEach(pl2=>{if(pl2.alive)pl2.hp=Math.min(pl2.maxHp,pl2.hp+(ef.healTick||0)*(pl2.healBonus||1));});
      if(ef.healZ)players.forEach(pl2=>{if(pl2.alive)pl2.hp=Math.min(pl2.maxHp,pl2.hp+(ef.healZ.a||0)*(pl2.healBonus||1));});
    }
    if(ef.t<=0)fieldFx.splice(i,1);
  }
}
function updPillars(dt){for(let i=pillars.length-1;i>=0;i--){const p=pillars[i];if(p.temp){p.life-=dt;if(p.life<=0||(p.hp!==undefined&&p.hp<=0))pillars.splice(i,1);}}}
function updParts(dt){for(let i=parts.length-1;i>=0;i--){const p=parts[i];p.x+=p.vx*dt;p.y+=p.vy*dt;p.vy+=55*dt;p.vx*=.97;p.life-=dt;if(p.life<=0)parts.splice(i,1);}}

// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function spP(o){projs.push({life:2.8,pierce:false,bounce:false,...o});}
function emitP(x,y,c,n,spd,nx=0,ny=0){for(let i=0;i<n;i++){const a=Math.random()*Math.PI*2,s=spd*(.4+Math.random()*.8),b=.26;parts.push({x,y,vx:(Math.cos(a)*(1-b)+nx*b)*s,vy:(Math.sin(a)*(1-b)+ny*b)*s,life:.3+Math.random()*.55,maxLife:.85,c,r:1.5+Math.random()*2.5});}}
function spawnFT(x,y,t,c,f){floats.push({x,y,text:t,color:c,t:1.1,font:f||'bold 13px Rajdhani,sans-serif'});}
function doShake(a,d){shakeA=a;shakeT=d;}
function showAnn(txt,dur){ann={text:txt,t:dur,max:dur};}
function h2r(h){return parseInt(h.slice(1,3),16)+','+parseInt(h.slice(3,5),16)+','+parseInt(h.slice(5,7),16);}

// â”€â”€â”€ LEVEL END â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function endLevel(){
  running=false;removeListeners();
  if(!completedLevels.includes(currentLevel))completedLevels.push(currentLevel);
  const lv=LEVELS[currentLevel];const bd=BOSS_DEFS[lv.boss];
  showScreen('levelcomplete');
  document.getElementById('lcBossEmoji').textContent=bd.emoji;
  document.getElementById('lcTitle').textContent=bd.name+' besiegt!';
  document.getElementById('lcBossName').textContent=lv.name.toUpperCase()+' â€” ABGESCHLOSSEN';
  document.getElementById('lcStats').innerHTML=`<div class="lc-stat"><b>${killCount}</b>Kills</div><div class="lc-stat"><b>${Math.ceil(levelTimer)}s</b>Zeit</div><div class="lc-stat"><b>${Math.ceil(Math.max(players[0].hp,0))}</b>HP Ã¼brig P1</div>`;
  const hasNext=currentLevel<LEVELS.length-1;
  document.getElementById('btnNext').style.display=hasNext?'block':'none';
  if(!hasNext)setTimeout(()=>{showScreen('win');document.getElementById('winsub').textContent=`Alle 7 Elemental-Bosse wurden besiegt! Du hast ${killCount} Feinde getÃ¶tet.`;},500);
}
function goNextLevel(){currentLevel++;startDraft();}
function startDraft(){showScreen('draft');initDraft();}
function endGame(win){
  running=false;removeListeners();hideTip();
  if(win)endLevel();else showScreen('lose');
}

// â”€â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rr(x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();}

function render(){
  const lv=LEVELS[currentLevel]||LEVELS[0];
  ctx.save();ctx.translate(shakeX,shakeY);
  ctx.fillStyle=lv.bg||'#030508';ctx.fillRect(-10,-10,GW+20,GH+20);
  ctx.strokeStyle=lv.gridCol||'#060f18';ctx.lineWidth=1;
  for(let x=0;x<GW;x+=64){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,GH);ctx.stroke();}
  for(let y=0;y<GH;y+=64){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(GW,y);ctx.stroke();}
  ctx.strokeStyle='#0f1e2e';ctx.lineWidth=2;ctx.strokeRect(PAD,PAD,GW-PAD*2,GH-PAD*2);
  ctx.strokeStyle='rgba(244,197,66,.13)';ctx.lineWidth=2;
  [[PAD,PAD],[GW-PAD,PAD],[GW-PAD,GH-PAD],[PAD,GH-PAD]].forEach(([cx,cy])=>{const s=18;ctx.beginPath();ctx.moveTo(cx,cy+s);ctx.lineTo(cx,cy);ctx.lineTo(cx+s,cy);ctx.stroke();});
  rendFx();rendPillars();rendProjs();rendParts();
  enemies.forEach(e=>{if(e.hp>0)rendEnemy(e);});
  players.forEach(pl=>rendPlayer(pl));
  for(const ft of floats){ctx.save();ctx.globalAlpha=Math.min(1,ft.t);ctx.font=ft.font;ctx.fillStyle=ft.color;ctx.textAlign='center';ctx.shadowColor=ft.color;ctx.shadowBlur=8;ctx.fillText(ft.text,ft.x,ft.y);ctx.restore();}
  ctx.restore();
  rendHUD();
  if(ann.t>0){const a=Math.min(1,ann.t/(ann.max*.4));ctx.save();ctx.globalAlpha=a;ctx.font='bold 22px Cinzel,serif';ctx.textAlign='center';ctx.fillStyle='#f4c542';ctx.shadowColor='#f4c542';ctx.shadowBlur=28;ctx.fillText(ann.text,GW/2,GH/2-18);ctx.restore();}
  if(gamePhase===1&&phaseCD>0){ctx.save();ctx.font='bold 52px Cinzel,serif';ctx.textAlign='center';ctx.fillStyle='#ef4444';ctx.shadowColor='#ef4444';ctx.shadowBlur=44;ctx.globalAlpha=.88;ctx.fillText(Math.ceil(phaseCD),GW/2,GH/2+24);ctx.restore();}
}

function rendFx(){
  for(const ef of fieldFx){ctx.save();const ec=EL[ef.el]?.c||'#fff';
   if(ef.type==='meter'){const pulse=.4+Math.sin(Date.now()*.014)*.25;ctx.globalAlpha=pulse;ctx.strokeStyle=ec;ctx.lineWidth=2;ctx.setLineDash([7,6]);ctx.beginPath();ctx.arc(ef.x,ef.y,ef.r,0,Math.PI*2);ctx.stroke();ctx.setLineDash([]);ctx.globalAlpha=1;ctx.font='bold 12px "Share Tech Mono"';ctx.fillStyle=ec;ctx.textAlign='center';ctx.shadowColor=ec;ctx.shadowBlur=12;ctx.fillText('â˜„ '+ef.t.toFixed(1)+'s',ef.x,ef.y+4);}
   else if(ef.type==='zone'||ef.type==='tornado'){const g=ctx.createRadialGradient(ef.x,ef.y,0,ef.x,ef.y,ef.r||80);g.addColorStop(0,`rgba(${h2r(ec)},.35)`);g.addColorStop(1,`rgba(${h2r(ec)},0)`);ctx.globalAlpha=.62;ctx.fillStyle=g;ctx.beginPath();ctx.arc(ef.x,ef.y,ef.r||80,0,Math.PI*2);ctx.fill();if(ef.type==='tornado'){for(let j=0;j<5;j++){const a=(ef.angle||0)+j*(Math.PI*2/5);ctx.strokeStyle='#ff6b1a';ctx.lineWidth=4;ctx.globalAlpha=.88;ctx.beginPath();ctx.arc(ef.x,ef.y,(ef.r||80)*.55,a,a+1.1);ctx.stroke();}}}
   else if(ef.type==='windwall'){ctx.globalAlpha=.4;ctx.fillStyle='rgba(79,195,247,.28)';ctx.fillRect(ef.x,ef.y,ef.w,ef.h);ctx.strokeStyle='#4fc3f7';ctx.lineWidth=2;ctx.strokeRect(ef.x,ef.y,ef.w,ef.h);}
   ctx.restore();
  }
}

function rendPillars(){
  for(const p of pillars){ctx.save();
    ctx.fillStyle='rgba(0,0,0,.4)';ctx.fillRect(p.x+5,p.y+5,p.w,p.h);
    const g=ctx.createLinearGradient(p.x,p.y,p.x+p.w,p.y+p.h);g.addColorStop(0,'#182838');g.addColorStop(1,'#0c1620');ctx.fillStyle=g;
    const isT=!!p.el;ctx.strokeStyle=isT?(EL[p.el]?.c||'#a3a86e'):'#2a3d50';ctx.lineWidth=isT?2:1.5;
    if(isT){ctx.shadowColor=EL[p.el]?.c;ctx.shadowBlur=8;}
    rr(p.x,p.y,p.w,p.h,4);ctx.fill();rr(p.x,p.y,p.w,p.h,4);ctx.stroke();ctx.shadowBlur=0;
    if(isT&&p.hp!==undefined){ctx.fillStyle='rgba(0,0,0,.5)';ctx.fillRect(p.x,p.y-5,p.w,3);ctx.fillStyle=EL[p.el]?.c||'#fff';ctx.fillRect(p.x,p.y-5,p.w*(p.hp/p.maxHp),3);}
    ctx.restore();
  }
}

function rendProjs(){
  for(const p of projs){ctx.save();
    if(p.isFusion){ctx.shadowColor=p.glow||p.color;ctx.shadowBlur=34;ctx.fillStyle=p.color;ctx.globalAlpha=.95;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();ctx.fillStyle='#fff';ctx.globalAlpha=.68;ctx.beginPath();ctx.arc(p.x,p.y,p.r*.35,0,Math.PI*2);ctx.fill();}
    else{ctx.shadowColor=p.glow||p.color;ctx.shadowBlur=12;ctx.fillStyle=p.color;ctx.globalAlpha=.88;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();}
    ctx.restore();
  }
}
function rendParts(){for(const p of parts){ctx.save();ctx.globalAlpha=(p.life/p.maxLife)*.8;ctx.fillStyle=p.c;ctx.shadowColor=p.c;ctx.shadowBlur=4;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();ctx.restore();}}

function rendEnemy(e){
  ctx.save();const E=EL[e.element];
  const bd=e.bossData;const phIdx=e.type==='boss'?getBossPhase():0;
  const pCol=e.type==='boss'?(phIdx===0?(bd?.color||E.c):phIdx===1?'#c026d3':'#ef4444'):e.type==='minion'?E.c:E.c;
  const pGlow=e.type==='boss'?(phIdx===0?(bd?.glow||E.g):phIdx===1?'#a21caf':'#dc2626'):E.g;
  if(e.stunT>0||e.frozenT>0){ctx.globalAlpha=.32+Math.sin(Date.now()*.022)*.1;ctx.fillStyle=e.frozenT>0?'#90caf9':'#f4c542';ctx.shadowColor=ctx.fillStyle;ctx.shadowBlur=24;ctx.beginPath();ctx.arc(e.x,e.y,e.r+14,0,Math.PI*2);ctx.fill();}
  if((e.blindT||0)>0){ctx.globalAlpha=.26;ctx.fillStyle='#fde68a';ctx.beginPath();ctx.arc(e.x,e.y,e.r+9,0,Math.PI*2);ctx.fill();}
  ctx.globalAlpha=e.hitFlash>.05?.9:.55;ctx.fillStyle=e.hitFlash>.05?'#fff':pCol;ctx.shadowColor=e.hitFlash>.05?'#fff':pGlow;ctx.shadowBlur=e.hitFlash>.05?34:22;ctx.beginPath();ctx.arc(e.x,e.y,e.r,0,Math.PI*2);ctx.fill();
  ctx.globalAlpha=1;ctx.fillStyle=pCol;ctx.shadowColor=pGlow;ctx.shadowBlur=14;ctx.beginPath();ctx.arc(e.x,e.y,e.r-5,0,Math.PI*2);ctx.fill();
  // Spikes
  ctx.globalAlpha=.45;ctx.strokeStyle=pCol+'cc';ctx.lineWidth=2;
  ctx.save();ctx.translate(e.x,e.y);ctx.rotate(-e.angle*1.6);
  const spks=e.type==='boss'?phIdx===2?9:6:e.type==='minion'?3:4;
  for(let i=0;i<spks;i++){const a=(i/spks)*Math.PI*2;ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(Math.cos(a)*(e.r-5),Math.sin(a)*(e.r-5));ctx.stroke();}ctx.restore();
  ctx.globalAlpha=.82;ctx.font=(e.type==='minion'?'11px':'14px')+' serif';ctx.textAlign='center';ctx.fillText(E.e,e.x,e.y-e.r-(e.type==='minion'?4:8));
  if(e.charging){ctx.globalAlpha=.22+Math.sin(Date.now()*.04)*.1;ctx.fillStyle='#f97316';ctx.beginPath();ctx.arc(e.x,e.y,e.r+30,0,Math.PI*2);ctx.fill();}
  // HP bar
  const bw=e.r*2+8,bh=e.type==='boss'?6:4;ctx.globalAlpha=1;ctx.fillStyle='rgba(0,0,0,.55)';ctx.fillRect(e.x-bw/2,e.y+e.r+6,bw,bh);const hf=Math.max(0,e.hp/e.maxHp);ctx.fillStyle=hf>.5?'#4ade80':hf>.25?'#f4c542':'#f87171';ctx.fillRect(e.x-bw/2,e.y+e.r+6,bw*hf,bh);
  // Boss: phase markers on HP bar
  if(e.type==='boss'){[.67,.33].forEach(f=>{ctx.strokeStyle='rgba(244,197,66,.55)';ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(e.x-bw/2+bw*f,e.y+e.r+4);ctx.lineTo(e.x-bw/2+bw*f,e.y+e.r+12);ctx.stroke();});}
  ctx.restore();
}

function rendPlayer(pl){
  if(!pl.alive)return;ctx.save();
  if(pl.stealthOn)ctx.globalAlpha=.2;
  else if(pl.invul>0)ctx.globalAlpha=.68+Math.sin(Date.now()*.04)*.3;
  else if(pl.iframes>0&&Math.floor(Date.now()/80)%2===0)ctx.globalAlpha=.25;
  const lo=loadouts[pl.id],eA=EL[lo.elemA],eB=EL[lo.elemB],ac=lo.activeEl==='A'?eA:eB;
  ctx.globalAlpha*=.16;ctx.fillStyle=eB.c;ctx.shadowColor=eB.g;ctx.shadowBlur=20;ctx.beginPath();ctx.arc(pl.x,pl.y,pl.r+10,0,Math.PI*2);ctx.fill();
  ctx.globalAlpha*=3.2;ctx.fillStyle=eA.c;ctx.shadowColor=eA.g;ctx.shadowBlur=20;ctx.beginPath();ctx.arc(pl.x,pl.y,pl.r+3,0,Math.PI*2);ctx.fill();
  ctx.globalAlpha=1;ctx.fillStyle=ac.c;ctx.shadowColor=ac.g;ctx.shadowBlur=14;ctx.beginPath();ctx.arc(pl.x,pl.y,pl.r,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#fff';ctx.shadowBlur=4;ctx.globalAlpha=.65;ctx.beginPath();ctx.arc(pl.x,pl.y,pl.r*.3,0,Math.PI*2);ctx.fill();
  if(pl.invul>0){ctx.globalAlpha=.5;ctx.strokeStyle='#fde68a';ctx.lineWidth=3;ctx.shadowColor='#fde68a';ctx.shadowBlur=14;ctx.setLineDash([4,3]);ctx.beginPath();ctx.arc(pl.x,pl.y,pl.r+12,0,Math.PI*2);ctx.stroke();ctx.setLineDash([]);}
  if(pl.shield>0){ctx.globalAlpha=.5;ctx.strokeStyle='#42a5f5';ctx.lineWidth=3;ctx.shadowColor='#42a5f5';ctx.shadowBlur=10;ctx.beginPath();ctx.arc(pl.x,pl.y,pl.r+6,0,Math.PI*2);ctx.stroke();}
  if(pl.id===0){const{nx,ny}=aV(0);ctx.globalAlpha=.26;ctx.strokeStyle=ac.c;ctx.lineWidth=1.5;ctx.setLineDash([4,4]);ctx.beginPath();ctx.moveTo(pl.x+nx*(pl.r+4),pl.y+ny*(pl.r+4));ctx.lineTo(pl.x+nx*(pl.r+20),pl.y+ny*(pl.r+20));ctx.stroke();ctx.setLineDash([]);}
  ctx.globalAlpha=.62;ctx.font='bold 9px "Share Tech Mono"';ctx.fillStyle=EL[lo.elemA].c;ctx.textAlign='center';ctx.fillText('P'+(pl.id+1),pl.x,pl.y+pl.r+18);
  if(pl.chargeHeld&&pl.chargeT>0){const cf=Math.min(1,pl.chargeT/1.5);ctx.globalAlpha=1;ctx.fillStyle='rgba(0,0,0,.62)';ctx.fillRect(pl.x-34,pl.y-32,68,7);ctx.fillStyle=ac.c;ctx.shadowColor=ac.c;ctx.shadowBlur=8;ctx.fillRect(pl.x-34,pl.y-32,68*cf,7);}
  ctx.restore();
}

function rendHUD(){
  ctx.save();
  const boss=enemies.find(e=>e.type==='boss');const lv=LEVELS[currentLevel];
  // Boss HP
  if(boss&&gamePhase===2){
    const bd=boss.bossData;const phIdx=getBossPhase();
    const BW=380,BH=20,BX=(GW-BW)/2,BY=8;
    ctx.fillStyle='#070d18';rr(BX,BY,BW,BH,4);ctx.fill();ctx.strokeStyle='#1e2a38';ctx.lineWidth=1;rr(BX,BY,BW,BH,4);ctx.stroke();
    const bf=Math.max(0,boss.hp/boss.maxHp);
    const bc=phIdx===0?(bd?.color||'#a3a86e'):phIdx===1?'#c026d3':'#ef4444';
    ctx.fillStyle=bc;ctx.shadowColor=bc;ctx.shadowBlur=12;if(bf>0){rr(BX,BY,BW*bf,BH,4);ctx.fill();}ctx.shadowBlur=0;
    [.67,.33].forEach(f=>{ctx.strokeStyle='rgba(244,197,66,.4)';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(BX+BW*f,BY-2);ctx.lineTo(BX+BW*f,BY+BH+2);ctx.stroke();});
    ctx.font='bold 10px "Share Tech Mono"';ctx.textAlign='center';ctx.fillStyle='#d0dce8';ctx.fillText(bd?.emoji+' '+bd?.name+' â€” '+Math.max(0,Math.ceil(boss.hp))+'/'+boss.maxHp,GW/2,BY+13);
    ctx.font='bold 10px Rajdhani';ctx.fillStyle=bc;
    ctx.fillText(['P1 â€” Normal','P2 â€” Aggro!','P3 â€” ENRAGE!'][phIdx],GW/2,BY+30);
    // Status icons
    const sts=[];if(boss.stunT>0)sts.push({t:'STUN',c:'#f4c542'});if(boss.frozenT>0)sts.push({t:'FROST',c:'#90caf9'});if(boss.slowT>0)sts.push({t:'SLOW',c:'#4fc3f7'});if(boss.burnT>0)sts.push({t:'BURN',c:'#ff6b1a'});if(boss.poisonT>0)sts.push({t:'GIFT',c:'#4ade80'});if((boss.blindT||0)>0)sts.push({t:'BLIND',c:'#fde68a'});
    sts.forEach((s,i)=>{ctx.font='8px "Share Tech Mono"';ctx.fillStyle=s.c;ctx.fillText(s.t,BX+i*52+26,BY+44);});
  }
  // Guardians
  if(gamePhase<2){
    const gs=enemies.filter(e=>e.type==='guardian');
    ctx.font='bold 11px Rajdhani';ctx.textAlign='center';ctx.fillStyle='#f4c542';
    ctx.fillText(lv.emoji+' '+lv.name+' â€” WÃ„CHTER: '+gs.filter(e=>e.hp<=0).length+'/'+gs.length+(gamePhase===1?' â€” BOSS IN '+Math.ceil(phaseCD)+'s!':''),GW/2,26);
  }
  // Minions
  const mc=enemies.filter(e=>e.type==='minion'&&e.hp>0).length;
  if(mc>0){ctx.font='bold 9px Rajdhani';ctx.textAlign='center';ctx.fillStyle='#ef4444';ctx.fillText('âš  MINIONS: '+mc,GW/2,44);}
  // Level indicator
  ctx.font='bold 9px "Share Tech Mono"';ctx.textAlign='left';ctx.fillStyle='#2a3a4a';
  ctx.fillText('LEVEL '+(currentLevel+1)+'/'+LEVELS.length+' â€” '+lv.name.toUpperCase(),PAD+5,14);
  // PLAYER HUDS
  const SKW=70,SKH=56,SKG=7;
  players.forEach(pl=>{
    if(!pl.alive){ctx.save();ctx.font='bold 18px Cinzel,serif';ctx.textAlign='center';ctx.fillStyle='#f87171';ctx.shadowColor='#f87171';ctx.shadowBlur=18;ctx.fillText('P'+(pl.id+1)+' GEFALLEN',pl.id===0?210:GW-210,GH/2+60);ctx.restore();return;}
    const lo=loadouts[pl.id];const hudX=pl.id===0?12:GW-12-248;const hudY=GH-128;
    const PW=248,PH=12;
    ctx.fillStyle='#07101c';rr(hudX,hudY,PW,PH,4);ctx.fill();ctx.strokeStyle='#1a2535';ctx.lineWidth=1;rr(hudX,hudY,PW,PH,4);ctx.stroke();
    const pf=Math.max(0,pl.hp/pl.maxHp),pc=pf>.5?'#4ade80':pf>.25?'#f4c542':'#f87171';
    ctx.fillStyle=pc;ctx.shadowColor=pc;ctx.shadowBlur=8;if(pf>0){rr(hudX,hudY,PW*pf,PH,4);ctx.fill();}ctx.shadowBlur=0;
    ctx.font='9px "Share Tech Mono"';ctx.fillStyle='#d0dce8';ctx.textAlign='left';ctx.fillText('P'+(pl.id+1)+' HP '+Math.max(0,Math.ceil(pl.hp))+'/'+pl.maxHp,hudX+4,hudY+9);
    if(pl.shield>0){ctx.fillStyle='#42a5f5';ctx.textAlign='right';ctx.fillText('ğŸ›¡'+Math.ceil(pl.shield),hudX+PW,hudY+9);}
    const eA=EL[lo.elemA],eB=EL[lo.elemB];
    ctx.font='bold 9px Rajdhani';ctx.fillStyle=lo.activeEl==='A'?eA.c:eA.c+'66';ctx.textAlign='left';
    ctx.fillText(eA.e+' '+(lo.activeEl==='A'?'â—€':''),hudX,hudY+24);
    ctx.fillStyle=lo.activeEl==='B'?eB.c:eB.c+'66';ctx.fillText(eB.e+' '+(lo.activeEl==='B'?'â—€':''),hudX+70,hudY+24);
    if(pl.stealthOn){ctx.fillStyle='#a855f7';ctx.shadowColor='#a855f7';ctx.shadowBlur=10;ctx.fillText('ğŸ‘» STEALTH'+(pl.stealthCrit?' KRIT':''),hudX,hudY+36);}
    const fsk=lo.fusion?{name:lo.fusion.n,cd:lo.fusion.cd*(1-(pl.fusionCDR||0)),element:lo.fusion.el,tags:['FUSION'],desc:lo.fusion.d,status:null,synergy:null}:null;
    const bars=[
      {sk:lo.activeEl==='A'?lo.lmbA:lo.lmbB,key:'lmb',lbl:pl.id===0?'LMB':'U',badge:EL[curEl(pl.id)].e},
      {sk:lo.activeEl==='A'?lo.rmbA:lo.rmbB,key:'rmb',lbl:pl.id===0?'RMB':'O',badge:EL[curEl(pl.id)].e},
      {sk:lo.qSkill,key:'q',lbl:pl.id===0?'Q':'1',badge:EL[lo.elemA].e},
      {sk:lo.eSkill,key:'e',lbl:pl.id===0?'E':'2',badge:EL[lo.elemB].e},
      {sk:fsk,key:'r',lbl:pl.id===0?'R':'3',badge:lo.fusion?.e||'âš¡'},
    ];
    const sbY=GH-SKH-10,sbX=pl.id===0?12:GW-12-(5*(SKW+SKG)-SKG);
    bars.forEach(({sk,key,lbl,badge},i)=>{
      if(!sk)return;const bx=sbX+i*(SKW+SKG),by=sbY;
      const ec=EL[sk.element||lo.elemA]?.c||'#fff';const cdN=pl.cds[key]||0,cdMax=sk.cd||1,frac=Math.min(1,cdN/cdMax);
      ctx.fillStyle='#060d18';rr(bx,by,SKW,SKH,6);ctx.fill();
      ctx.strokeStyle=ec;ctx.lineWidth=1.5;ctx.globalAlpha=frac>0?.15:.45;rr(bx,by,SKW,SKH,6);ctx.stroke();ctx.globalAlpha=1;
      if(frac>0){ctx.fillStyle='rgba(0,0,0,.7)';rr(bx,by,SKW,SKH*frac,6);ctx.fill();ctx.font='bold 11px "Share Tech Mono"';ctx.fillStyle='#555';ctx.textAlign='center';ctx.fillText(cdN.toFixed(1),bx+SKW/2,by+SKH/2+4);}
      if(frac===0){ctx.globalAlpha=.07+Math.sin(Date.now()*.006)*.04;ctx.fillStyle=ec;rr(bx,by,SKW,SKH,6);ctx.fill();ctx.globalAlpha=1;}
      if(key==='r'){ctx.font='bold 7px "Share Tech Mono"';ctx.fillStyle=frac>0?'#2a3a4a':ec;ctx.textAlign='center';ctx.fillText('FUSION',bx+SKW/2,by+SKH-16);}
      if(key==='rmb'&&pl.chargeHeld){const cf=Math.min(1,pl.chargeT/1.5);ctx.fillStyle=ec;ctx.globalAlpha=.5;rr(bx,by+SKH-5,SKW*cf,5,0);ctx.fill();ctx.globalAlpha=1;}
      ctx.font='16px serif';ctx.textAlign='center';ctx.fillText(badge,bx+SKW/2,by+28);
      ctx.font='7px "Share Tech Mono"';ctx.fillStyle='#3a5060';ctx.fillText(lbl,bx+SKW/2,by+10);
      const nm=(sk.name||'â€”').length>9?(sk.name||'â€”').slice(0,8)+'â€¦':sk.name||'â€”';
      ctx.font='bold 8px Rajdhani';ctx.fillStyle=frac>0?'#2a3a4a':ec;ctx.fillText(nm,bx+SKW/2,by+SKH-6);
    });
  });
  ctx.restore();
}

// â”€â”€â”€ TOOLTIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkTip(e){
  if(!running||!loadouts[0])return;const r=cv.getBoundingClientRect();const px=e.clientX-r.left,py=e.clientY-r.top;
  const SKW=70,SKH=56,SKG=7;
  for(let p=0;p<2;p++){if(!loadouts[p]||!players[p]?.alive)continue;const lo=loadouts[p];const pl=players[p];const fsk=lo.fusion?{name:lo.fusion.n,cd:lo.fusion.cd,element:lo.fusion.el,tags:['FUSION'],desc:lo.fusion.d,status:'Kombiniert '+EL[lo.elemA].n+' + '+EL[lo.elemB].n,synergy:'Nutze wenn CDs ready!'}:null;
  const slots=[lo.activeEl==='A'?lo.lmbA:lo.lmbB,lo.activeEl==='A'?lo.rmbA:lo.rmbB,lo.qSkill,lo.eSkill,fsk];
  const sbY=GH-SKH-10,sbX=p===0?12:GW-12-(5*(SKW+SKG)-SKG);
  for(let i=0;i<5;i++){if(px>=sbX+i*(SKW+SKG)&&px<=sbX+i*(SKW+SKG)+SKW&&py>=sbY&&py<=sbY+SKH){showTip(slots[i],e.clientX,e.clientY);return;}}}
  hideTip();
}
function showTip(sk,ex,ey){
  if(!sk)return;const E=EL[sk.element]||EL.fire;
  const tags=(sk.tags||[]).map(t=>`<span class="tg" style="background:${E.c}18;color:${E.c};border:1px solid ${E.c}44">${t}</span>`).join('');
  const stats=`${sk.dmg>0?`<div class="tv">âš” <b>${sk.dmg}</b></div>`:''}${sk.cd>0?`<div class="tv">â± <b>${sk.cd}s</b></div>`:''}`;
  document.getElementById('tip').innerHTML=`<div class="tn">${sk.name}</div><div class="tm">${E.e} ${E.n.toUpperCase()}</div><div class="tt2">${tags}</div><div class="ts2">${stats}</div><div class="tdiv"></div><div class="td">${sk.desc||''}</div>${sk.status?`<div class="tst">ğŸ“ ${sk.status}</div>`:''}${sk.synergy?`<div class="tsy">âš¡ ${sk.synergy}</div>`:''}`;
  const tip=document.getElementById('tip');tip.classList.add('on');tip.style.left=Math.max(4,ex-244)+'px';tip.style.top=Math.max(4,ey-tip.offsetHeight-14)+'px';
}
function hideTip(){document.getElementById('tip').classList.remove('on');}
window.addEventListener('load',()=>showScreen('menu'));
</script>
</body>
</html>
